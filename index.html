<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANI Professional Manufacturing & Inventory System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --dark-bg: #2c3e50;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-bg);
            color: #343a40;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: auto;
            background: var(--card-bg);
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        h1 {
            color: var(--dark-bg);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        h2 {
            color: var(--dark-bg);
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .home-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background-color: #f1f3f5;
            padding: 25px;
            border-left: 5px solid var(--primary-color);
        }

        .dashboard-card h3 {
            margin: 10px 0 0;
            font-size: 1rem;
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
        }

        .dashboard-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-bg);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-link {
            padding: 12px 22px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            margin-bottom: -2px;
            color: #6c757d;
            transition: all 0.2s;
        }

        .tab-link.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
            color: #343a40;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Added new styling for tables to enable scrolling */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        /* Fixed table header to prevent scrolling with content */
        thead tr {
            position: sticky;
            top: 0;
            background-color: var(--dark-bg);
            z-index: 10;
        }

        th,
        td {
            padding: 14px;
            border: 1px solid #dee2e6;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: var(--dark-bg);
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: var(--light-bg);
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input,
        select,
        button {
            padding: 12px;
            border: 1px solid #ced4da;
            font-size: 1rem;
            transition: all 0.2s;
        }

        input:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, .25);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        #vendorForm {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            flex-wrap: wrap;
        }

        .info-box {
            background-color: #eaf5ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 10px 0;
            font-weight: 500;
        }

        #wip-workflow-container,
        #rec-workflow-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        #wip-details-box,
        #rec-details-box {
            background: #f1f3f5;
            padding: 20px;
        }

        .wip-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .size-quantity-section {
            grid-column: 1 / -1;
            background: #fbfdff;
            border: 1px solid #e9ecef;
            padding: 20px;
            margin-top: 10px;
        }

        .size-quantity-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .size-input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .size-input-group input {
            width: 80px;
            text-align: center;
        }

        .size-input-group .size-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .add-size-btn {
            background-color: #28a745;
        }

        .delete-btn {
            background-color: #e74c3c;
        }

        .edit-btn {
            background-color: #ffc107;
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fff;
            color: #343a40;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #ccc;
            width: 90%;
            max-width: 950px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--dark-bg);
            border: none;
            margin: 0;
        }

        .close-button {
            color: #888;
            font-size: 32px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 20px;
        }

        .modal-card h3 {
            color: var(--dark-bg);
            margin-top: 0;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .modal-card p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .modal-card strong {
            color: #555;
            margin-right: 8px;
        }

        .progress-section {
            grid-column: 1 / -1;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
        }

        .stage-header{
            display: flex;
            justify-content: center;
        }

        .progress-bar-fill {
            height: 25px;
            background: var(--success-color);
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            color: #fff;
            transition: width 0.5s ease;
        }

        .stages-list {
            list-style: none;
            padding: 0;
            grid-column: 1 / -1;
        }

        .stage-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            margin-bottom: 15px;
            padding: 20px;
            border-left: 5px solid #bdc3c7;
        }

        .stage-item.completed {
            border-color: var(--success-color);
            background-color: #f0fff4;
        }

        .stage-item.in-progress {
            border-color: var(--warning-color);
            background-color: #fffaf0;
        }
        
        #auth-modal {
            display: none;
        }
        
        #main-app-content {
            display: none;
        }
        
        #auth-modal .modal-content {
            max-width: 400px;
            margin: 10% auto;
        }
        
        #auth-form .form-group {
            margin-bottom: 15px;
        }
        
        #auth-form button {
            width: 100%;
            margin-top: 10px;
        }
        
        #auth-form p {
            text-align: center;
            margin-top: 15px;
        }

        /* Styles for the PDF Receipt table */
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 10px;
        }
        .receipt-table th, .receipt-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        .receipt-table th {
            background-color: #f2f2f2;
        }

         #challanProgressTable th{
            min-width: 120px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>BANI Advanced Manufacturing & Inventory System</h1>
        
        <div id="auth-buttons" style="text-align: right; margin-bottom: 20px;">
            <button id="sign-out-btn" style="background-color: #e74c3c; display:none;">Sign Out</button>
        </div>

        <div id="main-app-content">
            <div class="tabs">
                <button class="tab-link active" id="home-tab">Home</button>
                <button class="tab-link" id="record-output-tab">Record Output</button>
                <button class="tab-link" id="issue-to-vendor-tab">Issue to Vendor</button>
                <button class="tab-link" id="receive-from-vendor-tab">Receive from Vendor</button>
                <button class="tab-link" id="record-receiving-tab">Record Receiving</button>
                <button class="tab-link" id="manage-vendors-tab">Manage Vendors</button>
                <button class="tab-link" id="transactions-tab">Transactions</button>
            </div>
    
            <div id="Home" class="tab-content active">
                <div class="home-dashboard">
                    <div class="dashboard-card">
                        <div class="value" id="stockOnHand">0</div>
                        <h3>Stock on Hand</h3>
                    </div>
                    <div class="dashboard-card">
                        <div class="value" id="workInProgress">0</div>
                        <h3>Work in Progress</h3>
                    </div>
                    <div class="dashboard-card">
                        <div class="value" id="finishedAwaiting">0</div>
                        <h3>Finished (Awaiting Receipt)</h3>
                    </div>
                    <div class="dashboard-card">
                        <div class="value" id="totalReceived">0</div>
                        <h3>Total Received</h3>
                    </div>
                </div>
                <h2>Inventory Dashboard</h2>
                <div class="table-container">
                    <table id="stockTable">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Total Qty</th>
                                <th>Current Stage</th>
                                <th>WIP</th>
                                <th>Finished</th>
                                <th>Received</th>
                                <th>Last Input Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
    
                <hr style="margin: 30px 0;">
    
                <h2>SKU Progress Visualization</h2>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="sku-search-input" placeholder="Search by SKU..." style="width: 250px; padding: 10px;">
                    <button id="sku-search-btn" style="padding: 10px;">Search</button>
                </div>
                
                <div id="visualization-container" style="display: none; padding: 20px; background: #f8f9fa; border: 1px solid #e9ecef;">
                    <h3>Progress for SKU: <span id="visualization-sku-title"></span></h3>
                    <div style="max-height: 400px;">
                        <canvas id="challanProgressChart"></canvas>
                    </div>
                    <h4 style="margin-top: 20px;">Challan Details</h4>
                    <div class="table-container" style="max-height: 200px;">
                        <table id="challanDetailsTable">
                            <thead>
                                <tr>
                                    <th>Challan No</th>
                                    <th>Quantity</th>
                                    <th>Current Stage</th>
                                    <th>Vendor</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
    
            <div id="RecordOutput" class="tab-content">
                <h2>Record Output Material</h2>
                <form id="outputForm" class="form-grid">
                    <div class="form-group"><label for="sku">SKU</label><input type="text" id="sku" required></div>
                    <div class="form-group"><label for="itemType">Item Type</label><select id="itemType" required>
                            <option value="">Select Type</option>
                            <option value="Co-ord">Co-ord</option>
                            <option value="SKD">SKD</option>
                            <option value="Dress">Dress</option>
                            <option value="Dupatta">Dupatta</option>
                            <option value="Custom">Add Custom...</option>
                        </select><input type="text" id="customItemType" placeholder="Specify custom type" style="display:none; margin-top:10px;"></div>
                    <div class="form-group"><label for="color">Color</label><select id="color" required>
                        <option value="">Select Color</option>
                        <option value="Custom">Add New Color...</option>
                        </select><input type="text" id="customColor" placeholder="Specify new color" style="display:none; margin-top:10px;"></div>
                    <div class="form-group"><label for="challanNo">Challan No</label><input type="text" id="challanNo" required></div>
                    <div class="form-group"><label for="rate">Rate (per item)</label><input type="number" id="rate" step="0.01" required></div>
                    <div class="form-group"><label for="outputVendor">Vendor for Cutting</label><select id="outputVendor" required></select></div>
                    <div class="form-group"><label for="date-issued">Date Issued</label><input type="date" id="date-issued" required></div>
                    <div class="form-group"><label for="remarks">Remarks</label><input type="text" id="remarks"></div>
                    <div class="size-quantity-section">
                        <h3>Size-wise Quantities</h3>
                        <div id="size-quantity-container" class="size-quantity-container"></div>
                        <div style="margin-top: 15px; display:flex; align-items:center; gap:20px;">
                            <button type="button" class="add-size-btn" id="add-output-size-btn"><i class="fas fa-plus"></i> Add Size</button>
                            <strong id="total-qty-display">Total Quantity: 0</strong>
                        </div>
                    </div>
                    <button type="submit" style="grid-column: 1 / -1; padding: 15px; font-size: 1.1rem;">Issue for Cutting</button>
                </form>
            </div>
    
            <div id="IssueToVendor" class="tab-content">
                <h2>Issue to Vendor</h2>
                <form id="issueForm">
                    <div id="issue-workflow-container">
                        <div class="form-group">
                            <label for="issueChallan">1. Select Challan to Update</label>
                            <select id="issueChallan" required></select>
                        </div>
                        <div id="issue-details-box" style="display: none;">
                            <div class="info-box">Current Stage: <strong id="issueCurrentStage"></strong> | Available Qty: <strong id="issueAvailableQty"></strong></div>
                            <div class="wip-grid" style="margin-top: 20px;">
                                <div class="form-group"><label for="issueNextStage">2. Move to Stage</label><select id="issueNextStage" required></select></div>
                                <div class="form-group"><label for="issueVendor">3. Assign to Vendor</label><select id="issueVendor" required></select></div>
                                <div class="form-group"><label for="date-issued-wip">4. Date Issued</label><input type="date" id="date-issued-wip" required></div>
                            </div>
                        </div>
                    </div>
                    <div id="issue-size-section" class="size-quantity-section" style="display: none;">
                        <h4>Quantities to Update by Size</h4>
                        <div id="issue-size-container" class="size-quantity-container"></div>
                    </div>
                    <div class="form-group" style="margin-top:20px;">
                        <label for="issueNewChallan">New Challan No (Optional)</label>
                        <input type="text" id="issueNewChallan" placeholder="Leave blank to use existing challan number">
                    </div>
                    <button type="submit" style="margin-top: 20px; width:100%; padding: 15px; font-size: 1.1rem;">Issue Material</button>
                </form>
            </div>

            <div id="ReceiveFromVendor" class="tab-content">
                <h2>Receive from Vendor</h2>
                <form id="receiveForm">
                    <div class="form-group">
                        <label for="receiveChallan">1. Select Challan to Receive</label>
                        <select id="receiveChallan" required></select>
                    </div>
                    <div id="receive-details-box" style="display: none;">
                        <div class="info-box">Current Stage: <strong id="receiveCurrentStage"></strong> | Vendor: <strong id="receiveVendor"></strong></div>
                        <div class="wip-grid" style="margin-top: 20px;">
                            <div class="form-group"><label for="receiveNewChallan">New Challan No (Optional)</label><input type="text" id="receiveNewChallan" placeholder="Leave blank to use existing challan number"></div>
                            <div class="form-group"><label for="date-received-wip">Date Received</label><input type="date" id="date-received-wip" required></div>
                        </div>
                    </div>
                    <div id="receive-size-section" class="size-quantity-section" style="display: none;">
                        <h4>Quantities to Receive by Size</h4>
                        <div id="receive-size-container" class="size-quantity-container"></div>
                    </div>
                    <button type="submit" style="margin-top: 20px; width:100%; padding: 15px; font-size: 1.1rem;">Record Received Material</button>
                </form>
            </div>
    
            <div id="RecordReceiving" class="tab-content">
                <h2>Record Receiving Material</h2>
                <form id="receivingForm">
                    <div class="form-group"><label for="recChallan">Select Challan to Receive</label><select id="recChallan" required></select></div>
                    <div id="rec-details-box" style="display:none;">
                        <p class="info-box"><strong>SKU:</strong> <span id="recSku"></span> | <strong>Color:</strong> <span id="recColor"></span> | <strong>Vendor:</strong> <span id="recVendor"></span></p>
                    </div>
                    <div class="form-group"><label for="date-received">Date Received</label><input type="date" id="date-received" required></div>
                    <div id="rec-size-section" class="size-quantity-section" style="display: none;">
                        <h3>Quantities to Receive by Size</h3>
                        <div id="rec-size-container" class="size-quantity-container"></div>
                    </div>
                    <button type="submit" style="margin-top:20px; width:100%; padding: 15px;">Mark as Received</button>
                </form>
            </div>
    
            <div id="ManageVendors" class="tab-content">
                <h2>Manage Vendors</h2>
                <form id="vendorForm">
                    <div class="form-group"><label for="vendorName">Vendor Name</label><input type="text" id="vendorName" required></div>
                    <div class="form-group"><label>Job Types (Select all that apply)</label>
                        <div id="jobTypesContainer" style="display:flex; flex-wrap:wrap; gap: 15px; padding: 10px; border: 1px solid #ced4da;">
                        </div>
                    </div>
                    <button type="submit">Register Vendor</button>
                </form>
                <hr style="margin: 30px 0;">
                <h3>Registered Vendors</h3>
                <div class="table-container">
                    <table id="vendorTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Job Types</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
    
            <div id="Transactions" class="tab-content">
                <h2>Transactions Log</h2>
                <div class="table-container">
                    <table id="transactionTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Challan</th>
                                <th>SKU</th>
                                <th>Type</th>
                                <th>Color</th>
                                <th>Stage</th>
                                <th>Size</th>
                                <th>Qty</th>
                                <th>Vendor</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sign In or Sign Up</h2>
            </div>
            <form id="auth-form">
                <div class="form-group">
                    <label for="auth-email">Email</label>
                    <input type="email" id="auth-email" required>
                </div>
                <div class="form-group">
                    <label for="auth-password">Password</label>
                    <input type="password" id="auth-password" required>
                </div>
                <button type="submit" id="sign-in-btn">Sign In</button>
                <button type="button" id="sign-up-btn">Sign Up</button>
                <p id="auth-error-message" style="color: red;"></p>
            </form>
        </div>
    </div>
    
    <!-- SKU Edit Modal -->
    <div id="editSkuModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Edit SKU: <span id="edit-modal-title-sku"></span></h2>
                <button class="close-button" id="close-edit-sku-modal">&times;</button>
            </div>
            <form id="editSkuForm">
                <input type="hidden" id="editSkuOriginal">
                <div class="form-group">
                    <label for="edit-sku">SKU</label>
                    <input type="text" id="edit-sku" required>
                </div>
                <div id="sku-materials-container">
                    <!-- Dynamic material forms will be inserted here -->
                </div>
                <button type="submit" style="margin-top: 20px;">Save All Changes</button>
            </form>
        </div>
    </div>
    
    <!-- Vendor Edit Modal -->
    <div id="vendorEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Vendor</h2>
                <button class="close-button" id="close-vendor-edit-modal">&times;</button>
            </div>
            <form id="editVendorForm">
                <input type="hidden" id="editVendorId">
                <div class="form-group">
                    <label for="editVendorName">Vendor Name</label>
                    <input type="text" id="editVendorName" required>
                </div>
                <div class="form-group">
                    <label>Job Types</label>
                    <div id="editJobTypesContainer" style="display:flex; flex-wrap:wrap; gap: 15px; padding: 10px; border: 1px solid #ced4da;">
                    </div>
                </div>
                <button type="submit" style="margin-top: 20px;">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div id="materialEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Material Details</h2>
                <button class="close-button" id="close-material-edit-modal">&times;</button>
            </div>
            <form id="editMaterialForm">
                <input type="hidden" id="editMaterialDocId">
                <div class="form-grid">
                    <div class="form-group"><label for="editSku">SKU</label><input type="text" id="editSku" required></div>
                    <div class="form-group"><label for="editItemType">Item Type</label><select id="editItemType" required>
                            <option value="">Select Type</option>
                            <option value="Co-ord">Co-ord</option>
                            <option value="SKD">SKD</option>
                            <option value="Dress">Dress</option>
                            <option value="Dupatta">Dupatta</option>
                        </select><input type="text" id="editCustomItemType" placeholder="Specify custom type" style="display:none; margin-top:10px;"></div>
                    <div class="form-group"><label for="editColor">Color</label><input type="text" id="editColor" required></div>
                    <div class="form-group"><label for="editRate">Rate (per item)</label><input type="number" id="editRate" step="0.01" required></div>
                    <div class="size-quantity-section" style="grid-column: 1 / -1;">
                        <h3>Size-wise Initial Quantities</h3>
                        <div id="edit-size-quantity-container" class="size-quantity-container"></div>
                        <div style="margin-top: 15px; display:flex; align-items:center; gap:20px;">
                            <button type="button" class="add-size-btn" id="add-edit-size-btn"><i class="fas fa-plus"></i> Add Size</button>
                            <strong id="edit-total-qty-display">Total Quantity: 0</strong>
                        </div>
                    </div>
                </div>
                <button type="submit" style="grid-column: 1 / -1; padding: 15px; font-size: 1.1rem; margin-top: 20px;">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="skuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SKU: <span id="modal-title-sku"></span></h2>
                <button class="close-button" id="close-sku-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-card">
                    <h3><i class="fas fa-info-circle"></i> SKU Details</h3>
                    <p><strong>SKU:</strong> <span id="modal-sku"></span></p>
                    <p><strong>Type:</strong> <span id="modal-type"></span></p>
                    <p><strong>Colors:</strong> <span id="modal-colors"></span></p>
                </div>
                <div class="modal-card">
                    <h3><i class="fas fa-boxes"></i> Stock Summary</h3>
                    <p><strong>Total Output:</strong> <span id="modal-total-output"></span></p>
                    <p><strong>Total Received:</strong> <span id="modal-total-received"></span></p>
                    <p><strong>Total WIP:</strong> <span id="modal-total-wip"></span></p>
                </div>
                <div class="progress-section">
                    <h3><i class="fas fa-tasks"></i> Overall Progress (% Received)</h3>
                    <div class="progress-bar-container">
                        <div id="modal-progress-bar" class="progress-bar-fill" style="width: 0%;">0%</div>
                    </div>
                </div>
                <div class="stages-section" style="grid-column: 1 / -1;">
                    <h3><i class="fas fa-industry"></i> Challan Progress</h3>
                    <div class="table-container" style="max-height: 400px;">
                        <table id="challanProgressTable">
                            <thead>
                                <tr>
                                    <th>Challan No</th>
                                    <th>Initial Challan No</th>
                                    <th>Previous Stage</th>
                                    <th>Color</th>
                                    <th>Qty</th>
                                    <th>Size Qty</th>
                                    <th>Stage</th>
                                    <th>Vendor</th>
                                    <th>Status</th>
                                    <th>Date Issued</th>
                                    <th>Date Received</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="custom-alert" class="modal">
        <div class="modal-content" style="max-width: 300px; text-align: center; padding: 20px;">
            <p id="alert-message" style="margin: 0;"></p>
            <button id="alert-ok-btn" style="margin-top: 20px;">OK</button>
        </div>
    </div>

    <div id="custom-confirm" class="modal">
        <div class="modal-content" style="max-width: 300px; text-align: center; padding: 20px;">
            <p id="confirm-message" style="margin: 0;"></p>
            <div style="margin-top: 20px;">
                <button id="confirm-yes-btn" style="background-color: #2ecc71; margin-right: 10px;">Yes</button>
                <button id="confirm-no-btn" style="background-color: #e74c3c;">No</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // NOTE: Functions that need to be globally accessible must be outside the module script.
        function createSizeInputField(size, containerId, quantity = 0) {
            const container = document.getElementById(containerId);
            const group = document.createElement('div');
            group.className = 'size-input-group';
            group.innerHTML = `<label class="size-label">${size}</label><input type="number" min="0" value="${quantity}" data-size="${size}">`;
            container.appendChild(group);
            const input = group.querySelector('input');
            if (containerId.includes('quantity')) {
                input.addEventListener('input', () => {
                    const { total } = getQuantitiesFromContainer(containerId);
                    document.getElementById(containerId.startsWith('edit') ? 'edit-total-qty-display' : 'total-qty-display').textContent = `Total Quantity: ${total}`;
                });
            }
            return input;
        }

        function getQuantitiesFromContainer(containerId) {
            const quantities = {};
            let total = 0;
            document.querySelectorAll(`#${containerId} input[data-size]`).forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    quantities[input.dataset.size] = qty;
                    total += qty;
                }
            });
            return { quantities, total };
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // This variable is now correctly loaded from the environment
        const firebaseConfig = {
            apiKey: "AIzaSyCa9ujZAkO8d7_QLv1KWOOEJ3ww8rFddh0",
            authDomain: "banistock-57f35.firebaseapp.com",
            projectId: "banistock-57f35",
            storageBucket: "banistock-57f35.firebasestorage.app",
            messagingSenderId: "921264942139",
            appId: "1:921264942139:web:7e53870dc9a48cd406401e",
            measurementId: "G-3FVJTK0MX0"
        };
        

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        let materials = [];
        let vendors = [];
        let transactions = [];
        let myChart;

        const STAGES = ["Cutting", "Embroidery", "Printing", "Stitching", "Button Work", "Finishing"];
        const INDEPENDENT_STAGES = ["Alteration", "Repress"];
        const FINAL_STAGE = STAGES[STAGES.length - 1];
        const DEFAULT_SIZES = ["S", "M", "L", "XL"];
        const collections = {
            materials: "materials",
            vendors: "vendors",
            transactions: "transactions"
        };
        
        // Custom Alert/Confirmation
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').style.display = 'block';
        }

        // Custom confirm function with a callback
        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('custom-confirm').style.display = 'block';
            document.getElementById('confirm-yes-btn').onclick = (e) => {
                e.stopPropagation();
                onConfirm(true);
                closeModal('custom-confirm');
            };
            document.getElementById('confirm-no-btn').onclick = (e) => {
                e.stopPropagation();
                onConfirm(false);
                closeModal('custom-confirm');
            };
        }

        function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
            document.querySelectorAll(".tab-link").forEach(tl => tl.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
            renderAll();
        }

        function sumQuantities(obj) {
            return Object.values(obj || {}).reduce((s, q) => s + q, 0);
        }

        async function addTransaction(data, remarks) {
            try {
                if (!isAuthReady) return;
                const materialDoc = materials.find(m => m.data.challans.some(c => c.challanNo === data.challanNo));
                const material = materialDoc ? materialDoc.data : null;
                if (!material) return;

                const transactionCollection = collection(db, `artifacts/${appId}/users/${userId}/${collections.transactions}`);
                
                Object.keys(data.quantities).forEach(size => {
                    addDoc(transactionCollection, {
                        date: data.date,
                        challanNo: data.challanNo,
                        sku: material.sku,
                        type: material.type,
                        color: data.color || material.color,
                        stage: data.stage,
                        size: size,
                        qty: data.quantities[size],
                        vendor: data.vendor,
                        remarks
                    });
                });
            } catch (e) {
                console.error("Error adding transaction: ", e);
            }
        }

        // --- UI Rendering ---
        function renderHomePage() {
            let stockOnHand = 0,
                workInProgress = 0,
                finishedAwaiting = 0,
                totalReceived = 0;
            const stockTbody = document.querySelector("#stockTable tbody");
            stockTbody.innerHTML = '';

            const skus = {};
            materials.forEach(materialDoc => {
                const material = materialDoc.data;
                const docId = materialDoc.id;
                
                if (!skus[material.sku]) {
                    skus[material.sku] = {
                        materials: [],
                        totalInitial: 0,
                        totalWIP: 0,
                        totalFinished: 0,
                        totalReceived: 0,
                        earliestDate: null,
                        latestInputDate: null,
                    };
                }
                
                const skuData = skus[material.sku];
                skuData.materials.push(materialDoc);
                skuData.totalInitial += sumQuantities(material.initialQuantities);
                skuData.totalReceived += sumQuantities(material.receivedQuantities);
                
                let latestStageIndex = -1;
                material.challans.forEach(c => {
                    const challanQty = sumQuantities(c.quantities);
                    const stageIndex = STAGES.indexOf(c.stage);
                    if (stageIndex > latestStageIndex) latestStageIndex = stageIndex;
                    if (c.stage === FINAL_STAGE) skuData.totalFinished += challanQty;
                    else skuData.totalWIP += challanQty;
                    
                    const challanDate = new Date(c.date_issued);
                    if (!skuData.earliestDate || challanDate < new Date(skuData.earliestDate)) {
                        skuData.earliestDate = c.date_issued;
                    }
                    if (c.date_received && (!skuData.latestInputDate || new Date(c.date_received) > new Date(skuData.latestInputDate))) {
                        skuData.latestInputDate = c.date_received;
                    }
                });
                
                skuData.currentStage = latestStageIndex > -1 ? STAGES[latestStageIndex] : 'Not Started';
            });
            
            Object.keys(skus).forEach(sku => {
                const skuData = skus[sku];
                const totalStock = skuData.totalInitial - skuData.totalWIP - skuData.totalFinished - skuData.totalReceived;
                stockOnHand += totalStock;
                workInProgress += skuData.totalWIP;
                finishedAwaiting += skuData.totalFinished;
                totalReceived += skuData.totalReceived;
                
                const row = stockTbody.insertRow();
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => showSkuModal(sku));
                row.innerHTML = `<td>${sku}</td><td>${skuData.totalInitial}</td>
                                 <td>${skuData.currentStage}</td><td>${skuData.totalWIP}</td><td>${skuData.totalFinished}</td><td>${skuData.totalReceived}</td>
                                 <td>${skuData.latestInputDate || 'N/A'}</td>
                                 <td>
                                     <button class="edit-btn" data-sku="${sku}">Edit</button>
                                     <button class="delete-btn" data-sku="${sku}">Delete</button>
                                 </td>`;
            });
            
            document.getElementById('stockOnHand').textContent = stockOnHand;
            document.getElementById('workInProgress').textContent = workInProgress;
            document.getElementById('finishedAwaiting').textContent = finishedAwaiting;
            document.getElementById('totalReceived').textContent = totalReceived;
            
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditMaterialModal(materials.find(m => m.data.sku === e.target.dataset.sku).id);
            }));
            
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showConfirm("Are you sure you want to delete this material record? All associated WIP and transaction history will also be deleted.", async (confirmed) => {
                    if (confirmed) {
                        const sku = e.target.dataset.sku;
                        const materialDocsToDelete = materials.filter(m => m.data.sku === sku);
                        for (const doc of materialDocsToDelete) {
                           await deleteMaterial(doc.id);
                        }
                    }
                });
            }));
            
            // Render default chart
            if (Object.keys(skus).length > 0) {
                const firstSku = Object.keys(skus)[0];
                document.getElementById('sku-search-input').value = firstSku;
                visualizeSkuProgress(firstSku);
            }
        }
        
        function renderVendorTable() {
            const tbody = document.querySelector("#vendorTable tbody");
            tbody.innerHTML = '';
            vendors.forEach((vendorDoc) => {
                const vendor = vendorDoc.data;
                const docId = vendorDoc.id;
                const row = tbody.insertRow();
                row.innerHTML = `<td>${vendor.name}</td><td>${vendor.jobTypes.join(', ')}</td><td>
                    <button class="edit-btn" data-id="${docId}">Edit</button>
                    <button class="delete-btn" data-id="${docId}">Delete</button>
                    </td>`;
            });
            document.querySelectorAll('#vendorTable .edit-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditVendorModal(e.target.dataset.id);
            }));
            document.querySelectorAll('#vendorTable .delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showConfirm("Are you sure you want to delete this vendor?", async (confirmed) => {
                    if (confirmed) {
                        await deleteVendor(e.target.dataset.id);
                    }
                });
            }));
        }

        function renderTransactionsTable() {
            const tbody = document.querySelector("#transactionTable tbody");
            tbody.innerHTML = '';
            transactions.forEach(tDoc => {
                const t = tDoc.data;
                const row = tbody.insertRow();
                row.innerHTML = `<td>${t.date}</td><td>${t.challanNo}</td><td>${t.sku}</td><td>${t.type}</td><td>${t.color}</td><td>${t.stage}</td>
                                 <td>${t.size}</td><td>${t.qty}</td><td>${t.vendor}</td><td>${t.remarks || ''}</td>`;
            });
        }

        // --- Firestore Functions ---
        async function addMaterial(data) {
            try {
                if (!isAuthReady) {
                    console.error("Auth not ready.");
                    return;
                }
                const materialCollection = collection(db, `artifacts/${appId}/users/${userId}/${collections.materials}`);
                await addDoc(materialCollection, data);
                console.log("Material added successfully!");
                return true;
            } catch (e) {
                console.error("Error adding document: ", e);
                showAlert("Error adding material. Please try again.");
                return false;
            }
        }

        async function updateMaterial(docId, data) {
            try {
                if (!isAuthReady) {
                    console.error("Auth not ready.");
                    return;
                }
                const materialDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.materials}`, docId);
                await updateDoc(materialDocRef, data);
                console.log("Material updated successfully!");
                return true;
            } catch (e) {
                console.error("Error updating document: ", e);
                showAlert("Error updating material. Please try again.");
                return false;
            }
        }

        async function deleteMaterial(docId) {
            try {
                if (!isAuthReady) {
                    console.error("Auth not ready.");
                    return;
                }
                const materialDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.materials}`, docId);
                await deleteDoc(materialDocRef);
                showAlert("Material deleted successfully!");
                console.log('Material deleted successfully!');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showAlert("Error deleting material. Please try again.");
            }
        }

        async function addVendor(data) {
            try {
                if (!isAuthReady) return;
                const vendorCollection = collection(db, `artifacts/${appId}/users/${userId}/${collections.vendors}`);
                await addDoc(vendorCollection, data);
                console.log("Vendor added successfully!");
                return true;
            } catch (e) {
                console.error("Error adding vendor: ", e);
                showAlert("Error adding vendor. Please try again.");
                return false;
            }
        }

        async function updateVendor(docId, data) {
            try {
                if (!isAuthReady) return;
                const vendorDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.vendors}`, docId);
                await updateDoc(vendorDocRef, data);
                console.log("Vendor updated successfully!");
                return true;
            } catch (e) {
                console.error("Error updating vendor: ", e);
                showAlert("Error updating vendor. Please try again.");
                return false;
            }
        }

        async function deleteVendor(docId) {
            try {
                if (!isAuthReady) return;
                const vendorDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.vendors}`, docId);
                await deleteDoc(vendorDocRef);
                showAlert("Vendor deleted successfully!");
                console.log('Vendor deleted successfully!');
            } catch (e) {
                console.error("Error deleting vendor: ", e);
                showAlert("Error deleting vendor. Please try again.");
            }
        }

        // --- Form Population & Event Handlers ---
        document.getElementById('vendorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('vendorName').value;
            const jobTypes = Array.from(document.querySelectorAll('#jobTypesContainer input:checked')).map(cb => cb.value);
            if (!name || jobTypes.length === 0) {
                showAlert("Vendor name and at least one job type are required.");
                return;
            }
            if (vendors.some(v => v.data.name.toLowerCase() === name.toLowerCase())) {
                showAlert('A vendor with this name already exists.');
                return;
            }
            if (await addVendor({ name, jobTypes })) {
                this.reset();
                populateJobTypes('jobTypesContainer');
                showAlert('Vendor registered successfully!');
                console.log("Vendor registered successfully!");
            }
        });

        function populateJobTypes(containerId, selectedJobs = []) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            [...STAGES, ...INDEPENDENT_STAGES].forEach(stage => {
                const checked = selectedJobs.includes(stage) ? 'checked' : '';
                container.innerHTML += `<label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" value="${stage}" ${checked}> ${stage}</label>`;
            });
        }

        function populateColorDropdown(dropdownId) {
            const select = document.getElementById(dropdownId);
            select.innerHTML = '<option value="">Select Color</option><option value="Custom">Add New Color...</option>';
            const uniqueColors = new Set(materials.map(m => m.data.color).filter(Boolean));
            uniqueColors.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                select.appendChild(option);
            });
        }
        
        document.getElementById('color').addEventListener('change', function() {
            document.getElementById('customColor').style.display = (this.value === 'Custom') ? 'block' : 'none';
        });

        function openEditVendorModal(docId) {
            const vendorDoc = vendors.find(v => v.id === docId);
            const vendor = vendorDoc.data;
            document.getElementById('editVendorId').value = docId;
            document.getElementById('editVendorName').value = vendor.name;
            populateJobTypes('editJobTypesContainer', vendor.jobTypes);
            document.getElementById('vendorEditModal').style.display = 'block';
        }

        document.getElementById('editVendorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const docId = document.getElementById('editVendorId').value;
            const newName = document.getElementById('editVendorName').value;
            const newJobTypes = Array.from(document.querySelectorAll('#editJobTypesContainer input:checked')).map(cb => cb.value);
            if (!newName || newJobTypes.length === 0) {
                showAlert("Vendor name and at least one job type are required.");
                return;
            }
            if (vendors.some(v => v.data.name.toLowerCase() === newName.toLowerCase() && v.id !== docId)) {
                showAlert('A vendor with this name already exists.');
                return;
            }
            if (await updateVendor(docId, { name: newName, jobTypes: newJobTypes })) {
                closeModal('vendorEditModal');
                console.log("Vendor updated successfully!");
            }
        });

        document.getElementById('itemType').addEventListener('change', function() {
            document.getElementById('customItemType').style.display = (this.value === 'Custom') ? 'block' : 'none';
        });

        function openEditMaterialModal(docId) {
            const materialDoc = materials.find(m => m.id === docId);
            const material = materialDoc.data;
            document.getElementById('editMaterialDocId').value = docId;
            document.getElementById('editSku').value = material.sku;
            document.getElementById('editColor').value = material.color;
            document.getElementById('editRate').value = material.rate;
            document.getElementById('editItemType').value = material.type;
            document.getElementById('editCustomItemType').style.display = 'none';

            const sizeContainer = document.getElementById('edit-size-quantity-container');
            sizeContainer.innerHTML = '';
            let totalQty = 0;
            Object.entries(material.initialQuantities).forEach(([size, qty]) => {
                createSizeInputField(size, 'edit-size-quantity-container', qty);
                totalQty += qty;
            });
            document.getElementById('edit-total-qty-display').textContent = `Total Quantity: ${totalQty}`;
            document.getElementById('materialEditModal').style.display = 'block';
        }
        
        document.getElementById('editMaterialForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const docId = document.getElementById('editMaterialDocId').value;
            const { quantities, total } = getQuantitiesFromContainer('edit-size-quantity-container');
            if (total === 0) {
                showAlert('Total quantity cannot be zero.');
                return;
            }
            let itemType = document.getElementById('editItemType').value;
            if (itemType === 'Custom') itemType = document.getElementById('editCustomItemType').value.trim();
            if (!itemType) {
                showAlert('Please select or specify an item type.');
                return;
            }
            const updatedMaterial = {
                sku: document.getElementById('editSku').value,
                type: itemType,
                color: document.getElementById('editColor').value,
                rate: parseFloat(document.getElementById('editRate').value),
                initialQuantities: quantities,
            };

            const existingMaterial = materials.find(m => m.id === docId).data;
            const challans = existingMaterial.challans.map(c => {
                c.quantities = JSON.parse(JSON.stringify(quantities));
                return c;
            });
            const received = existingMaterial.receivedQuantities;
            
            const totalInitial = sumQuantities(quantities);
            const totalReceived = sumQuantities(received);

            if (totalReceived > totalInitial) {
                showAlert('The number of received items cannot exceed the new total initial quantity.');
                return;
            }
            
            const updateData = {
                ...updatedMaterial,
                challans,
                receivedQuantities: received
            };

            if (await updateMaterial(docId, updateData)) {
                closeModal('materialEditModal');
                openTab({ currentTarget: document.getElementById('home-tab') }, 'Home');
                console.log('Material updated and page refreshed.');
            }
        });

        function populateIssueChallanDropdown() {
            const select = document.getElementById('issueChallan');
            select.innerHTML = '<option value="">-- Select a Challan --</option>';
            materials.forEach(mDoc => {
                const m = mDoc.data;
                m.challans.filter(c => sumQuantities(c.quantities) > 0 && c.status === 'received').forEach(c => {
                    select.add(new Option(`Challan ${c.challanNo} (${m.color}, Stage: ${c.stage})`, `${mDoc.id}|${c.challanNo}`));
                });
            });
        }
        
        function populateReceiveChallanDropdown() {
            const select = document.getElementById('receiveChallan');
            select.innerHTML = '<option value="">-- Select a Challan --</option>';
            materials.forEach(mDoc => {
                const m = m.data;
                m.challans.filter(c => sumQuantities(c.quantities) > 0 && c.status === 'sent').forEach(c => {
                    select.add(new Option(`Challan ${c.challanNo} (${m.color}, Stage: ${c.stage})`, `${mDoc.id}|${c.challanNo}`));
                });
            });
        }
        
        document.getElementById('issueChallan').addEventListener('change', function() {
            const detailsBox = document.getElementById('issue-details-box');
            const sizeSection = document.getElementById('issue-size-section');
            if (!this.value) {
                detailsBox.style.display = 'none';
                sizeSection.style.display = 'none';
                return;
            }
            detailsBox.style.display = 'block';
            sizeSection.style.display = 'block';
            const [docId, challanNo] = this.value.split('|');
            const material = materials.find(m => m.id === docId).data;
            const challan = material.challans.find(c => c.challanNo === challanNo);
            document.getElementById('issueCurrentStage').textContent = challan.stage;
            document.getElementById('issueAvailableQty').textContent = sumQuantities(challan.quantities);
            const nextStageSelect = document.getElementById('issueNextStage');
            nextStageSelect.innerHTML = '<option value="">-- Select Next Stage --</option>';
            STAGES.slice(STAGES.indexOf(challan.stage) + 1).forEach(stage => nextStageSelect.add(new Option(stage, stage)));
            INDEPENDENT_STAGES.forEach(stage => nextStageSelect.add(new Option(stage, stage)));
            document.getElementById('issueVendor').innerHTML = '<option value="">-- Select Stage First --</option>';
            const sizeContainer = document.getElementById('issue-size-container');
            sizeContainer.innerHTML = '';
            Object.entries(challan.quantities).forEach(([size, qty]) => {
                const input = createSizeInputField(size, 'issue-size-container', qty);
                input.setAttribute('max', qty);
            });
            const firstInput = sizeContainer.querySelector('input');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        });

        document.getElementById('issueNextStage').addEventListener('change', function() {
            if (!this.value) {
                document.getElementById('issueVendor').innerHTML = '<option value="">-- Select Stage First --</option>';
                return;
            }
            populateVendorDropdown('issueVendor', this.value);
        });

        document.getElementById('issueForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const selectedId = document.getElementById('issueChallan').value;
            if (!selectedId) {
                showAlert('Please select a challan.');
                return;
            }
            const { quantities: quantitiesToUpdate, total } = getQuantitiesFromContainer('issue-size-container');
            if (total === 0) {
                showAlert('Please specify quantity for at least one size.');
                return;
            }
            const [docId, challanNo] = selectedId.split('|');
            const materialDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.materials}`, docId);
            const materialData = (await getDoc(materialDocRef)).data();
            const sourceChallan = materialData.challans.find(c => c.challanNo === challanNo);
            const nextStage = document.getElementById('issueNextStage').value;
            const dateIssued = document.getElementById('date-issued-wip').value;
            const issueVendor = document.getElementById('issueVendor').value;

            // Split the source challan
            const remainingQuantities = {};
            let remainingTotal = 0;
            const newChallanQuantities = {};
            let newChallanTotal = 0;
            
            Object.keys(sourceChallan.quantities).forEach(size => {
                const issuedQty = quantitiesToUpdate[size] || 0;
                const remainingQty = sourceChallan.quantities[size] - issuedQty;
                if (remainingQty > 0) {
                    remainingQuantities[size] = remainingQty;
                    remainingTotal += remainingQty;
                }
                if (issuedQty > 0) {
                    newChallanQuantities[size] = issuedQty;
                    newChallanTotal += issuedQty;
                }
            });

            // Update original challan with remaining quantities or delete if empty
            if (remainingTotal === 0) {
                materialData.challans = materialData.challans.filter(c => c.challanNo !== challanNo);
            } else {
                sourceChallan.quantities = remainingQuantities;
            }

            // Create new challan for the issued items
            const newChallanData = {
                challanNo: document.getElementById('issueNewChallan').value.trim() || `${challanNo}-${nextStage.toLowerCase()}`,
                initial_challan_no: sourceChallan.initial_challan_no || sourceChallan.challanNo,
                previous_stage: sourceChallan.stage,
                vendor: issueVendor,
                stage: nextStage,
                status: 'sent',
                quantities: newChallanQuantities,
                date_issued: dateIssued
            };
            materialData.challans.push(newChallanData);
            
            if (await updateMaterial(docId, materialData)) {
                await addTransaction({ ...newChallanData, sku: materialData.sku, color: materialData.color }, `Issued for ${nextStage}`);
                this.reset();
                document.getElementById('issue-details-box').style.display = 'none';
                document.getElementById('issue-size-section').style.display = 'none';
                showAlert('Material issued successfully!');
            }
        });

        document.getElementById('receiveChallan').addEventListener('change', function() {
            const detailsBox = document.getElementById('receive-details-box');
            const sizeSection = document.getElementById('receive-size-section');
            if (!this.value) {
                detailsBox.style.display = 'none';
                sizeSection.style.display = 'none';
                return;
            }
            detailsBox.style.display = 'block';
            sizeSection.style.display = 'block';
            const [docId, challanNo] = this.value.split('|');
            const material = materials.find(m => m.id === docId).data;
            const challan = material.challans.find(c => c.challanNo === challanNo);
            document.getElementById('receiveCurrentStage').textContent = challan.stage;
            document.getElementById('receiveVendor').textContent = challan.vendor;
            document.getElementById('receiveNewChallan').value = challan.challanNo; // Pre-populate with existing challan number
            const sizeContainer = document.getElementById('receive-size-container');
            sizeContainer.innerHTML = '';
            Object.entries(challan.quantities).forEach(([size, qty]) => {
                if (qty > 0) {
                    const group = document.createElement('div');
                    group.className = 'size-input-group';
                    group.innerHTML = `<label class="size-label">${size} (Av: ${qty})</label><input type="number" min="0" max="${qty}" value="${qty}" data-size="${size}">`;
                    sizeContainer.appendChild(group);
                }
            });
        });

        document.getElementById('receiveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const selectedId = document.getElementById('receiveChallan').value;
            if (!selectedId) {
                showAlert('Please select a challan.');
                return;
            }
            const { quantities: quantitiesToReceive, total } = getQuantitiesFromContainer('receive-size-container');
            if (total === 0) {
                showAlert('Please specify quantity to receive.');
                return;
            }
            const [docId, challanNo] = selectedId.split('|');
            const materialDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.materials}`, docId);
            const materialData = (await getDoc(materialDocRef)).data();
            const sourceChallan = materialData.challans.find(c => c.challanNo === challanNo);
            const dateReceived = document.getElementById('date-received-wip').value;
            const newChallanNo = document.getElementById('receiveNewChallan').value.trim() || sourceChallan.challanNo;

            // Update the challan status and date
            sourceChallan.status = 'received';
            sourceChallan.date_received = dateReceived;
            sourceChallan.challanNo = newChallanNo;

            if (await updateMaterial(docId, materialData)) {
                await addTransaction({ ...sourceChallan, date: dateReceived, sku: materialData.sku, color: materialData.color, quantities: quantitiesToReceive }, `Received from ${sourceChallan.stage} job.`);
                this.reset();
                document.getElementById('receive-details-box').style.display = 'none';
                document.getElementById('receive-size-section').style.display = 'none';
                showAlert('Items received successfully!');
            }
        });

        document.getElementById('receivingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const selectedId = document.getElementById('recChallan').value;
            if (!selectedId) {
                showAlert('Please select a challan.');
                return;
            }
            const { quantities: quantitiesToReceive, total } = getQuantitiesFromContainer('rec-size-container');
            if (total === 0) {
                showAlert('Please specify quantity to receive.');
                return;
            }
            const [docId, challanNo] = selectedId.split('|');
            const materialDocRef = doc(db, `artifacts/${appId}/users/${userId}/${collections.materials}`, docId);
            const materialData = (await getDoc(materialDocRef)).data();
            const sourceChallan = materialData.challans.find(c => c.challanNo === challanNo);
            const dateReceived = document.getElementById('date-received').value;


            Object.entries(quantitiesToReceive).forEach(([size, qty]) => {
                materialData.receivedQuantities[size] = (materialData.receivedQuantities[size] || 0) + qty;
                sourceChallan.quantities[size] -= qty;
                if (sourceChallan.quantities[size] === 0) delete sourceChallan.quantities[size];
            });
            if (Object.keys(sourceChallan.quantities).length === 0) materialData.challans = materialData.challans.filter(c => c !== sourceChallan);

            if (await updateMaterial(docId, materialData)) {
                await addTransaction({ ...sourceChallan, date: dateReceived, sku: materialData.sku, color: materialData.color, quantities: quantitiesToReceive }, `Received`);
                this.reset();
                document.getElementById('rec-details-box').style.display = 'none';
                document.getElementById('rec-size-section').style.display = 'none';
                showAlert('Items received successfully!');
            }
        });

        function populateVendorDropdown(dropdownId, jobType) {
            const select = document.getElementById(dropdownId);
            select.innerHTML = '<option value="">-- Select Vendor --</option>';
            vendors.filter(v => v.data.jobTypes.includes(jobType)).forEach(vendor => {
                select.add(new Option(vendor.data.name, vendor.data.name));
            });
        }
        
        function showSkuModal(sku) {
            const skuMaterials = materials.filter(m => m.data.sku === sku);
            if (skuMaterials.length === 0) return;
            
            let totalOutput = 0;
            let totalReceived = 0;
            let totalWIP = 0;
            let totalFinished = 0;
            let allChallans = [];
            const uniqueColors = new Set();
            
            skuMaterials.forEach(mDoc => {
                const material = mDoc.data;
                totalOutput += sumQuantities(material.initialQuantities);
                totalReceived += sumQuantities(material.receivedQuantities);
                
                if (material.color) {
                    uniqueColors.add(material.color);
                }

                material.challans.forEach(c => {
                    const challanQty = sumQuantities(c.quantities);
                    if (c.stage === FINAL_STAGE) {
                        totalFinished += challanQty;
                    } else if (INDEPENDENT_STAGES.includes(c.stage) && c.status === 'sent') {
                        totalWIP += challanQty; // Sent for independent job (50% progress)
                    } else if (INDEPENDENT_STAGES.includes(c.stage) && c.status === 'received') {
                         totalWIP += challanQty; // Received from independent job (100% progress)
                    } else if (c.status === 'sent') {
                        totalWIP += challanQty;
                    }
                    allChallans.push({
                        ...c,
                        color: material.color,
                        sku: material.sku,
                        materialDocId: mDoc.id
                    });
                });
            });
            
            const progressPercent = totalOutput > 0 ? (totalReceived / totalOutput) * 100 : 0;
            
            document.getElementById('modal-title-sku').textContent = sku;
            document.getElementById('modal-sku').textContent = sku;
            document.getElementById('modal-type').textContent = skuMaterials[0].data.type;
            document.getElementById('modal-colors').textContent = Array.from(uniqueColors).join(', ');
            document.getElementById('modal-total-output').textContent = totalOutput;
            document.getElementById('modal-total-received').textContent = totalReceived;
            document.getElementById('modal-total-wip').textContent = totalWIP + totalFinished;

            const progressBar = document.getElementById('modal-progress-bar');
            progressBar.style.width = `${progressPercent}%`;
            progressBar.textContent = `${Math.round(progressPercent)}%`;
            
            const challanTableBody = document.querySelector('#challanProgressTable tbody');
            challanTableBody.innerHTML = '';
            
            allChallans.sort((a, b) => new Date(a.date_issued) - new Date(b.date_issued));
            
            allChallans.forEach(c => {
                const row = challanTableBody.insertRow();
                const totalQty = sumQuantities(c.quantities);
                
                // Get size-wise quantities
                const sizeDistribution = Object.entries(c.quantities).map(([size, qty]) => `${size}: ${qty}`).join(', ');
                
                row.innerHTML = `
                    <td>${c.challanNo}</td>
                    <td>${c.initial_challan_no || 'N/A'}</td>
                    <td>${c.previous_stage || 'N/A'}</td>
                    <td>${c.color}</td>
                    <td>${totalQty}</td>
                    <td>${sizeDistribution}</td>
                    <td>${c.stage}</td>
                    <td>${c.vendor}</td>
                    <td>${c.status}</td>
                    <td>${c.date_issued || 'N/A'}</td>
                    <td>${c.date_received || 'N/A'}</td>
                    <td><button class="download-receipt-btn" data-challan-no="${c.challanNo}" data-material-id="${c.materialDocId}">Download</button></td>
                `;
            });
            
            // Add event listeners for new buttons
            document.querySelectorAll('.download-receipt-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const challanNo = e.target.dataset.challanNo;
                    const materialId = e.target.dataset.materialId;
                    downloadChallanReceipt(materialId, challanNo);
                });
            });


            document.getElementById('skuModal').style.display = 'block';
        }

        async function downloadChallanReceipt(materialId, challanNo) {
            const materialDoc = materials.find(m => m.id === materialId);
            if (!materialDoc) {
                showAlert('Material record not found.');
                return;
            }

            const materialData = materialDoc.data;
            const challan = materialData.challans.find(c => c.challanNo === challanNo);
            if (!challan) {
                showAlert('Challan record not found.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const margin = 15;
            const lineHeight = 7;
            let y = margin;
            const pageWidth = doc.internal.pageSize.getWidth();

            // Header
            doc.setFontSize(22);
            doc.text("Cheshaa Apparels India Pvt. Ltd.", pageWidth / 2, y, { align: 'center' });
            y += lineHeight;
            doc.setFontSize(10);
            doc.text("Manufacture & Exporter of Fashion Garments", pageWidth / 2, y, { align: 'center' });
            y += lineHeight;
            doc.text("Plot no 78, Bijwasan Rd, near Sarovar Portico Hotel,", pageWidth / 2, y, { align: 'center' });
            y += lineHeight;
            doc.text("Kapas Hera Extension, Kapas Hera, New Delhi, Delhi 110037", pageWidth / 2, y, { align: 'center' });
            y += lineHeight * 2;
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += lineHeight;

            // Challan & Date
            doc.setFontSize(14);
            doc.text(`CHALLAN`, pageWidth / 2, y, { align: 'center' });
            y += lineHeight;
            doc.setFontSize(12);
            doc.text(`No.: ${challan.challanNo}`, margin, y);
            doc.text(`Dated: ${new Date().toLocaleDateString()}`, pageWidth - margin, y, { align: 'right' });
            y += lineHeight;
            doc.text(`M/s: ${challan.vendor}`, margin, y);
            y += lineHeight * 2;

            // Table Header
            const tableHeaders = ['S.No.', 'Particulars', 'Qty.', 'Rate', 'Remarks'];
            const tableData = [];
            let serialNo = 1;
            Object.entries(challan.quantities).forEach(([size, qty]) => {
                tableData.push([
                    serialNo++,
                    `SKU: ${materialData.sku}, Color: ${materialData.color}, Type: ${materialData.type}, Size: ${size}`,
                    qty,
                    materialData.rate || 'N/A',
                    ''
                ]);
            });

            const startY = y;
            doc.autoTable({
                startY: startY,
                head: [tableHeaders],
                body: tableData,
                styles: {
                    fontSize: 10,
                    cellPadding: 3,
                    halign: 'left',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: [255, 255, 255]
                }
            });

            // Footer
            y = doc.autoTable.previous.finalY + 10;
            doc.text(`Receiver Signature`, margin, y);
            doc.text(`For Cheshaa Apparels India Pvt. Ltd.`, pageWidth - margin, y, { align: 'right' });
            y += lineHeight * 2;
            doc.text(`E. & O.E.`, margin, y);
            doc.text(`Auth. Sign.`, pageWidth - margin, y, { align: 'right' });
            
            doc.save(`Challan_${challan.challanNo}_Receipt.pdf`);
        }


        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = e => {
            // Check if the click is outside any modal content to close it
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
        
        document.getElementById('alert-ok-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal('custom-alert');
        });

        document.getElementById('close-material-edit-modal').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal('materialEditModal');
        });

        document.getElementById('close-edit-sku-modal').addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal('editSkuModal');
        });
        
        // --- Visualization Functions ---
        function visualizeSkuProgress(sku) {
            const materialDocs = materials.filter(m => m.data.sku === sku);
            const visContainer = document.getElementById('visualization-container');
            const title = document.getElementById('visualization-sku-title');
            
            if (materialDocs.length === 0) {
                visContainer.style.display = 'none';
                showAlert('No data found for this SKU.');
                return;
            }

            title.textContent = sku;
            visContainer.style.display = 'block';

            let allChallans = [];
            materialDocs.forEach(mDoc => {
                const material = mDoc.data;
                material.challans.forEach(c => {
                    allChallans.push({
                        ...c,
                        color: material.color
                    });
                });
            });

            const challanLabels = allChallans.map(c => `Challan ${c.challanNo}`);
            const wipQuantities = allChallans.map(c => c.stage !== FINAL_STAGE ? sumQuantities(c.quantities) : 0);
            const finishedQuantities = allChallans.map(c => c.stage === FINAL_STAGE ? sumQuantities(c.quantities) : 0);
            const challanDetailsBody = document.querySelector("#challanDetailsTable tbody");
            challanDetailsBody.innerHTML = '';

            // Populate the detailed challan table
            allChallans.forEach(challan => {
                const row = challanDetailsBody.insertRow();
                const totalQty = sumQuantities(challan.quantities);
                row.innerHTML = `
                    <td>${challan.challanNo}</td>
                    <td>${totalQty}</td>
                    <td>${challan.stage}</td>
                    <td>${challan.vendor}</td>
                `;
            });

            const ctx = document.getElementById('challanProgressChart').getContext('2d');
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: challanLabels,
                    datasets: [{
                        label: 'In Progress',
                        data: wipQuantities,
                        backgroundColor: '#3498db',
                    }, {
                        label: 'Finished',
                        data: finishedQuantities,
                        backgroundColor: '#2ecc71',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        }
                    }
                }
            });
        }
        
        // --- Firebase Setup ---
        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log(`User authenticated with UID: ${userId}`);
                        document.getElementById('auth-modal').style.display = 'none';
                        document.getElementById('main-app-content').style.display = 'block';
                        document.getElementById('sign-out-btn').style.display = 'block';
                        setupFirestoreListeners();
                    } else {
                        userId = null;
                        isAuthReady = false;
                        document.getElementById('auth-modal').style.display = 'block';
                        document.getElementById('main-app-content').style.display = 'none';
                        document.getElementById('sign-out-btn').style.display = 'none';
                        console.log("No user signed in.");
                    }
                });
            } catch (e) {
                console.error("Error setting up Firebase: ", e);
            }
        };
        
        // Handle auth form submission
        document.getElementById('auth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = '';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Sign-in failed: ", error);
                errorMessage.textContent = 'Invalid email or password. Please try again.';
            }
        });

        // Handle sign up button click
        document.getElementById('sign-up-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = '';
            
            if (password.length < 6) {
                errorMessage.textContent = 'Password should be at least 6 characters.';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showAlert('Account created successfully! You are now signed in.');
            } catch (error) {
                console.error("Sign-up failed: ", error);
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage.textContent = 'This email is already in use. Please sign in instead.';
                } else {
                    errorMessage.textContent = 'An error occurred during sign-up. Please try again.';
                }
            }
        });
        
        // Handle sign out button click
        document.getElementById('sign-out-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showAlert('You have been signed out.');
            } catch (error) {
                console.error("Sign out failed: ", error);
                showAlert('An error occurred during sign out. Please try again.');
            }
        });


        function setupFirestoreListeners() {
            if (!isAuthReady) {
                console.error("Firestore listeners not started, authentication not complete.");
                return;
            }
            // Materials
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/${collections.materials}`), (querySnapshot) => {
                materials = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderAll();
            }, (error) => {
                console.error("Error fetching materials: ", error);
            });

            // Vendors
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/${collections.vendors}`), async (querySnapshot) => {
                vendors = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                const warehouseExists = vendors.some(v => v.data.name === 'WAREHOUSE');
                if (!warehouseExists) {
                    // Check again before adding to avoid race conditions
                    const updatedVendors = (await getDocs(collection(db, `artifacts/${appId}/users/${userId}/${collections.vendors}`))).docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    if (!updatedVendors.some(v => v.data.name === 'WAREHOUSE')) {
                        await addVendor({ name: 'WAREHOUSE', jobTypes: ['Cutting'] });
                    }
                }
                renderAll();
            }, (error) => {
                console.error("Error fetching vendors: ", error);
            });

            // Transactions
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/${collections.transactions}`), (querySnapshot) => {
                transactions = querySnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })).sort((a, b) => new Date(b.data.date) - new Date(a.data.date));
                renderAll();
            }, (error) => {
                console.error("Error fetching transactions: ", error);
            });
        }

        function renderAll() {
            if (!isAuthReady) {
                return;
            }
            renderHomePage();
            renderVendorTable();
            populateIssueChallanDropdown();
            populateReceiveChallanDropdown();
            populateVendorDropdown('outputVendor', 'Cutting');
            populateColorDropdown('color');
            renderTransactionsTable();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            setupFirebase();
            document.getElementById('home-tab').addEventListener('click', (e) => openTab(e, 'Home'));
            document.getElementById('record-output-tab').addEventListener('click', (e) => openTab(e, 'RecordOutput'));
            document.getElementById('issue-to-vendor-tab').addEventListener('click', (e) => openTab(e, 'IssueToVendor'));
            document.getElementById('receive-from-vendor-tab').addEventListener('click', (e) => openTab(e, 'ReceiveFromVendor'));
            document.getElementById('record-receiving-tab').addEventListener('click', (e) => openTab(e, 'RecordReceiving'));
            document.getElementById('manage-vendors-tab').addEventListener('click', (e) => openTab(e, 'ManageVendors'));
            document.getElementById('transactions-tab').addEventListener('click', (e) => openTab(e, 'Transactions'));
            document.getElementById('add-output-size-btn').addEventListener('click', () => addSizeField('size-quantity-container'));
            document.getElementById('add-edit-size-btn').addEventListener('click', () => addSizeField('edit-size-quantity-container'));
            document.getElementById('sku-search-btn').addEventListener('click', () => {
                const sku = document.getElementById('sku-search-input').value;
                if (sku) {
                    visualizeSkuProgress(sku);
                }
            });
            openTab({ currentTarget: document.getElementById('home-tab') }, 'Home');
            populateJobTypes('jobTypesContainer');
            const sizeContainer = document.getElementById('size-quantity-container');
            DEFAULT_SIZES.forEach(s => createSizeInputField(s, 'size-quantity-container'));

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-issued').value = today;
            document.getElementById('date-issued-wip').value = today;
            document.getElementById('date-received-wip').value = today;
            document.getElementById('date-received').value = today;
        });
    </script>
</body>

</html>
