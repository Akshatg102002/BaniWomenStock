<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Record System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Firebase Configuration -->
    <script>
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyCZV-AReOyDWnmnhIKgDvmpUlO8GdJ6xWg",
            authDomain: "bani-40b68.firebaseapp.com",
            projectId: "bani-40b68",
            storageBucket: "bani-40b68.firebasestorage.app",
            messagingSenderId: "971923274030",
            appId: "1:971923274030:web:f122e5b124d08fc44a62bf",
            measurementId: "G-2WNYB3WNNY"
        });
    </script>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center hidden">
        <div class="login-container glass-morphism rounded-2xl fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4" style="margin: 0 auto;">
                    <i class="fas fa-boxes text-black text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Material Record System</h1>
                <p class="text-gray-400">Secure inventory management</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="form-label">
                        <i class="fas fa-user mr-2"></i>Username
                    </label>
                    <input type="text" id="username" class="form-input" placeholder="Enter your username" required>
                </div>

                <div>
                    <label for="password" class="form-label">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                </div>

                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>

                <div class="text-center">
                    <button type="button" id="demoLoginBtn" class="text-white hover:text-gray-300 font-medium" style="color: #ffffff; background: none; border: none; cursor: pointer;">
                        <i class="fas fa-play mr-1"></i>Try Demo Account
                    </button>
                </div>
            </form>

            <div id="loginMessage" class="message-box hidden"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden min-h-screen">
        <div class="container">
            <!-- Header -->
            <div class="dashboard-header rounded-2xl mb-8 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">
                            <i class="fas fa-warehouse mr-3"></i>Material Record System
                        </h1>
                        <p class="text-gray-300">Advanced inventory management dashboard</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="user-profile">
                            <div class="avatar" id="userAvatar">U</div>
                            <div>
                                <div class="font-semibold" id="userDisplayName">User</div>
                                <div class="text-sm text-gray-300" id="userIdDisplay">Loading...</div>
                            </div>
                        </div>
                        <button id="logoutBtn" class="btn btn-danger">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stats-card input">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Input</p>
                            <p class="text-2xl font-bold text-green-400" id="totalInput">0</p>
                        </div>
                        <div class="text-green-400 text-3xl">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                </div>

                <div class="stats-card output">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Output</p>
                            <p class="text-2xl font-bold text-red-400" id="totalOutput">0</p>
                        </div>
                        <div class="text-red-400 text-3xl">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>

                <div class="stats-card total">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Current Stock</p>
                            <p class="text-2xl font-bold text-blue-400" id="currentStock">0</p>
                        </div>
                        <div class="text-blue-400 text-3xl">
                            <i class="fas fa-boxes"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entry Type Selection -->
            <div class="glass-morphism rounded-2xl p-8 mb-8 fade-in">
                <div class="flex justify-center gap-6 mb-8">
                    <button id="inputBtn" class="btn-toggle active">
                        <i class="fas fa-plus mr-2"></i>Record New Material Input
                    </button>
                    <button id="outputBtn" class="btn-toggle inactive">
                        <i class="fas fa-minus mr-2"></i>Record Material Output
                    </button>
                </div>

                <!-- Master SKU File Upload -->
                <div class="flex flex-col items-center justify-center mb-8">
                    <label class="form-label text-center">
                        <i class="fas fa-upload mr-2"></i>Upload Master SKUs (CSV)
                    </label>
                    <input type="file" id="masterSkuFile" accept=".csv" class="file-input">
                    <p id="fileStatus" class="text-xs mt-2 text-gray-400">No file selected.</p>
                </div>

                <!-- Material Entry Form -->
                <div class="form-section">
                    <h2 id="formTitle" class="text-2xl font-bold text-white mb-6 text-center">
                        <i class="fas fa-plus mr-2"></i>Record New Material Input
                    </h2>
                    <form id="materialForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="date" class="form-label">
                                <i class="fas fa-calendar mr-2"></i>Date
                            </label>
                            <input type="date" id="date" class="form-input" required>
                        </div>
                        <div>
                            <label for="challanNo" class="form-label">
                                <i class="fas fa-receipt mr-2"></i>Challan No
                            </label>
                            <input type="text" id="challanNo" class="form-input" placeholder="e.g., CHN-2025-001" required>
                        </div>
                        <div id="skuInputContainer">
                            <label for="sku" class="form-label">
                                <i class="fas fa-barcode mr-2"></i>SKU
                            </label>
                            <input type="text" id="sku" class="form-input" placeholder="e.g., BW6085BLUE_DRS-S" list="sku-datalist" required>
                            <datalist id="sku-datalist"></datalist>
                        </div>
                        <div>
                            <label for="color" class="form-label">
                                <i class="fas fa-palette mr-2"></i>Color
                            </label>
                            <input type="text" id="color" class="form-input" placeholder="e.g., Blue">
                        </div>
                        <div>
                            <label for="size" class="form-label">
                                <i class="fas fa-ruler-horizontal mr-2"></i>Size
                            </label>
                            <input type="text" id="size" class="form-input" placeholder="e.g., S">
                        </div>
                        <div>
                            <label for="qty" class="form-label">
                                <i class="fas fa-sort-numeric-up mr-2"></i>Quantity
                            </label>
                            <input type="number" id="qty" class="form-input" min="1" required>
                        </div>
                        <div>
                            <label for="rate" class="form-label">
                                <i class="fas fa-rupee-sign mr-2"></i>Rate (per unit)
                            </label>
                            <input type="number" id="rate" class="form-input" step="0.01" min="0" required>
                        </div>
                        <div id="vendorNameInputContainer" class="lg:col-span-3">
                            <label for="vendorName" class="form-label">
                                <i class="fas fa-store mr-2"></i>Vendor Name
                            </label>
                            <input type="text" id="vendorName" class="form-input" placeholder="e.g., Myntra - SJIT" required>
                        </div>
                        <div id="challanSelectContainer" class="lg:col-span-3" style="display: none;">
                            <!-- Challan dropdown for output will be dynamically inserted here -->
                        </div>
                        <div class="lg:col-span-3 flex justify-center mt-6">
                            <button type="submit" class="btn btn-primary text-lg px-8 py-4">
                                <i class="fas fa-save mr-2"></i>Add Record
                            </button>
                        </div>
                    </form>
                    <div id="messageBox" class="message-box hidden"></div>
                </div>
            </div>

            <!-- Filter and Records Display -->
            <div class="glass-morphism rounded-2xl p-8 fade-in">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <h2 class="text-3xl font-bold text-white">
                        <i class="fas fa-table mr-3"></i>Stock
                    </h2>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <!-- Date Filter -->
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div>
                                <label for="startDate" class="form-label hidden sm:block">Start Date</label>
                                <input type="date" id="startDate" class="form-input w-full sm:w-auto">
                            </div>
                            <div>
                                <label for="endDate" class="form-label hidden sm:block">End Date</label>
                                <input type="date" id="endDate" class="form-input w-full sm:w-auto">
                            </div>
                        </div>

                        <!-- Vendor Filter -->
                        <select id="vendorFilter" class="form-input w-full sm:w-auto">
                            <option value="all">All Vendors</option>
                        </select>

                        <!-- Search Box -->
                        <div class="search-box w-full sm:w-auto">
                            <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                            <i class="fas fa-search search-icon"></i>
                        </div>

                        <!-- Export Button -->
                        <button id="exportBtn" class="export-btn w-full sm:w-auto">
                            <i class="fas fa-download"></i>Export CSV
                        </button>
                    </div>
                </div>

                <!-- Aggregated Records Table -->
                <div class="overflow-x-auto mb-12">
                    <table id="aggregatedRecordsTable">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-calendar mr-2"></i>Date</th>
                                <th scope="col"><i class="fas fa-barcode mr-2"></i>SKU</th>
                                <th scope="col"><i class="fas fa-palette mr-2"></i>Color</th>
                                <th scope="col"><i class="fas fa-ruler-horizontal mr-2"></i>Size</th>
                                <th scope="col"><i class="fas fa-store mr-2"></i>Vendor</th>
                                <th scope="col"><i class="fas fa-rupee-sign mr-2"></i>Latest Rate</th>
                                <th scope="col"><i class="fas fa-arrow-down mr-2"></i>Total Input Qty</th>
                                <th scope="col"><i class="fas fa-arrow-up mr-2"></i>Total Output Qty</th>
                                <th scope="col"><i class="fas fa-boxes mr-2"></i></i>Remaining Stock</th>
                                <th scope="col"><i class="fas fa-cog mr-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="aggregatedRecordsTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-8 text-gray-400">
                                    <i class="fas fa-inbox text-4xl mb-4 block"></i>
                                    No records found.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Transaction Log Section -->
                
            </div>
        </div>
    </div>

    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        let app;
        let db;
        let userId = null;

        // Hardcoded user credentials for demonstration
        const users = {
            'admin': { password: 'admin123', name: 'Administrator', id: 'admin_001' },
            'user': { password: 'user123', name: 'Standard User', id: 'user_001' },
            'demo': { password: 'demo', name: 'Demo User', id: 'demo_001' }
        };

        let currentUser = null;
        let allRecords = [];
        let aggregatedStock = {};
        let masterSKUs = []; // New array to hold data from the CSV file
        let currentEditingRecord = null; // Track the record being edited

        // Default to 'Input' tab on load
        let currentEntryType = 'Input';

        // Get all relevant DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const mainDashboard = document.getElementById('mainDashboard');
        const loginForm = document.getElementById('loginForm');
        const demoLoginBtn = document.getElementById('demoLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userDisplayName = document.getElementById('userDisplayName');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const masterSkuFile = document.getElementById('masterSkuFile');
        const fileStatus = document.getElementById('fileStatus');

        const inputBtn = document.getElementById('inputBtn');
        const outputBtn = document.getElementById('outputBtn');
        const formTitle = document.getElementById('formTitle');
        const materialForm = document.getElementById('materialForm');
        const messageBox = document.getElementById('messageBox');
        const aggregatedRecordsTableBody = document.getElementById('aggregatedRecordsTableBody');

        const vendorFilter = document.getElementById('vendorFilter');
        const searchInput = document.getElementById('searchInput');
        const exportBtn = document.getElementById('exportBtn');

        let dateInput = document.getElementById('date');
        let challanNoInput = document.getElementById('challanNo');
        let colorInput = document.getElementById('color');
        let sizeInput = document.getElementById('size'); // New size input
        let qtyInput = document.getElementById('qty');
        let rateInput = document.getElementById('rate');

        let skuInputContainer = document.getElementById('skuInputContainer');
        let vendorNameInputContainer = document.getElementById('vendorNameInputContainer');
        let challanSelectContainer = document.getElementById('challanSelectContainer');
        let skuDataList = document.getElementById('sku-datalist');

        let skuInputText = null;
        let vendorInputText = null;
        let vendorSelectDropdown = null;
        let skuSelectDropdown = null;
        let challanSelectDropdown = null;

        const totalInputDisplay = document.getElementById('totalInput');
        const totalOutputDisplay = document.getElementById('totalOutput');
        const currentStockDisplay = document.getElementById('currentStock');

        // Function to initialize Firebase and check for a saved user session
        const initializeFirebase = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (!firebaseConfig.projectId) {
                    console.error("Firebase 'projectId' not provided in __firebase_config.");
                    showMessage('Firebase configuration error: Project ID missing.', 'error', 'loginMessage');
                    showLogin();
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                console.log("Firebase Firestore initialized.");

                // Check for a user saved in localStorage to bypass login
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        userId = currentUser.id;
                        console.log("Loaded user from localStorage:", currentUser);
                        showDashboard();
                    } catch (error) {
                        console.error('Error parsing saved user from localStorage:', error);
                        localStorage.removeItem('currentUser'); // Clear invalid data
                        showLogin();
                    }
                } else {
                    console.log("No user found in localStorage. Showing login screen.");
                    showLogin();
                }

            } catch (error) {
                console.error("Error initializing Firebase Firestore:", error);
                showMessage('Error initializing application. Please try again.', 'error', 'loginMessage');
                if (userIdDisplay) userIdDisplay.textContent = 'Error';
                showLogin();
            }
        };

        // Function to display a message to the user
        const showMessage = (message, type, elementId = 'messageBox') => {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Message box element '${elementId}' not found. Message: ${message}`);
                return;
            }
            element.textContent = message;
            element.className = `message-box ${type === 'success' ? 'message-success' : 'message-error'}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        };

        // Function to set up login form event listeners
        const setupLoginListeners = () => {
             // Handle standard login form submission
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = usernameInput.value;
                    const password = passwordInput.value;
    
                    if (users[username] && users[username].password === password) {
                        currentUser = { username, ...users[username] };
                        userId = currentUser.id;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        console.log("Login successful. currentUser:", currentUser, "userId:", userId);
                        showDashboard();
                    } else {
                        showMessage('Invalid username or password.', 'error', 'loginMessage');
                    }
                });
            }
            
            // Handle demo login button click
            if (demoLoginBtn) {
                demoLoginBtn.addEventListener('click', () => {
                    const demoUser = users['demo'];
                    currentUser = { username: 'demo', ...demoUser };
                    userId = currentUser.id;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showDashboard();
                });
            }
        }

        // Function to log the user out
        const logout = () => {
            currentUser = null;
            userId = null;
            localStorage.removeItem('currentUser');
            if (window.confirm) {
                window.confirm('Logged out successfully!');
            }
            showLogin();
        };

        // Function to show the login screen
        const showLogin = () => {
            if (loginScreen) loginScreen.classList.remove('hidden');
            if (mainDashboard) mainDashboard.classList.add('hidden');
            if (loginMessage) loginMessage.classList.add('hidden');
        };

        // Function to show the main dashboard
        const showDashboard = () => {
            console.log("Entering showDashboard function. Current user:", currentUser);

            if (loginScreen) loginScreen.classList.add('hidden');
            if (mainDashboard) mainDashboard.classList.remove('hidden');

            if (userDisplayName) userDisplayName.textContent = currentUser.name;
            if (userIdDisplay) userIdDisplay.textContent = currentUser.id;
            if (userAvatar) userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();

            if (userId && db) {
                setupRealtimeListener();
                updateFileStatus(); // Update the status message for the SKU list
            } else {
                console.error("Cannot setup dashboard: userId or db is not ready. Data might not load.");
                showMessage("Dashboard data could not be loaded. Please re-login.", "error", 'messageBox');
                logout();
            }
        };

        // Function to clear the form fields
        const clearForm = () => {
            dateInput.value = new Date().toISOString().split('T')[0];
            if (challanNoInput) challanNoInput.value = '';
            if (colorInput) colorInput.value = '';
            if (sizeInput) sizeInput.value = ''; // Clear the size input
            if (qtyInput) qtyInput.value = '';
            if (rateInput) rateInput.value = '';
            if (qtyInput) qtyInput.max = '';

            const skuInput = document.getElementById('sku');
            const vendorInput = document.getElementById('vendorName');
            const vendorSelect = document.getElementById('vendorSelect');
            const skuSelect = document.getElementById('skuSelect');
            const challanSelect = document.getElementById('challanSelect');

            if (skuInput) skuInput.value = '';
            if (vendorInput) vendorInput.value = '';
            if (vendorSelect) vendorSelect.value = 'Select Vendor...';
            if (skuSelect) skuSelect.innerHTML = '<option value="Select SKU...">Select SKU...</option>';
            if (challanSelect) challanSelect.innerHTML = '<option value="Select Challan...">Select Challan...</option>';
            
            currentEditingRecord = null;
            // Change button text back to Add Record
            document.querySelector('#materialForm button[type="submit"]').textContent = 'Add Record';
        };

        // Function to update the dashboard statistics cards
        const updateStatistics = () => {
            let totalInputQty = 0;
            let totalOutputQty = 0;

            for (const key in aggregatedStock) {
                totalInputQty += aggregatedStock[key].inputQty;
                totalOutputQty += aggregatedStock[key].outputQty;
            }

            const stockQty = totalInputQty - totalOutputQty;

            totalInputDisplay.textContent = totalInputQty.toLocaleString();
            totalOutputDisplay.textContent = totalOutputQty.toLocaleString();
            currentStockDisplay.textContent = stockQty.toLocaleString();
        };

        // Function to aggregate records for the summary table
        const calculateAggregatedStock = (records) => {
            const tempAggregatedStock = {};

            records.forEach(record => {
                const key = `${record.sku}-${record.color || 'N/A'}-${record.vendorName}-${record.size || 'N/A'}`; // Added size to the key
                if (!tempAggregatedStock[key]) {
                    tempAggregatedStock[key] = {
                        id: record.id,
                        date: record.date,
                        sku: record.sku,
                        color: record.color,
                        vendorName: record.vendorName,
                        size: record.size, // Added size
                        latestRate: 0,
                        inputQty: 0,
                        outputQty: 0,
                        timestamp: null
                    };
                }

                if (record.type === 'Input') {
                    tempAggregatedStock[key].inputQty += record.qty;
                    // Update rate and timestamp only if it's a newer input record
                    if (!tempAggregatedStock[key].timestamp || record.timestamp > tempAggregatedStock[key].timestamp) {
                        tempAggregatedStock[key].latestRate = record.rate;
                        tempAggregatedStock[key].timestamp = record.timestamp;
                    }
                } else if (record.type === 'Output') {
                    tempAggregatedStock[key].outputQty += record.qty;
                }
            });

            aggregatedStock = tempAggregatedStock;
        };

        // Function to render the aggregated stock table
        const renderAggregatedRecordsTable = (stockToDisplay) => {
            aggregatedRecordsTableBody.innerHTML = '';

            if (Object.keys(stockToDisplay).length === 0) {
                aggregatedRecordsTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-8 text-gray-400">
                            <i class="fas fa-inbox text-4xl mb-4 block"></i>
                            No records found.
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedStock = Object.values(stockToDisplay).sort((a, b) => {
                if (a.sku < b.sku) return -1;
                if (a.sku > b.sku) return 1;
                if (a.color < b.color) return -1;
                if (a.color > b.color) return 1;
                return 0;
            });

            sortedStock.forEach(item => {
                const remaining = item.inputQty - item.outputQty;
                const row = aggregatedRecordsTableBody.insertRow();

                row.innerHTML = `
                    <td>${item.date || 'N/A'}</td>
                    <td><span style="font-family: monospace; font-size: 0.75rem;">${item.sku}</span></td>
                    <td>${item.color || 'N/A'}</td>
                    <td>${item.size || 'N/A'}</td>
                    <td>${item.vendorName}</td>
                    <td>₹${parseFloat(item.latestRate).toFixed(2)}</td>
                    <td class="font-semibold text-green-400">${item.inputQty.toLocaleString()}</td>
                    <td class="font-semibold text-red-400">${item.outputQty.toLocaleString()}</td>
                    <td class="font-bold ${remaining < 0 ? 'text-red-500' : 'text-blue-400'}">${remaining.toLocaleString()}</td>
                    <td>
                        <button onclick="editRecord('${item.id}')" class="edit-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteRecord('${item.id}')" class="delete-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        };

        // Function to edit a record
        const editRecord = (recordId) => {
            const recordToEdit = allRecords.find(r => r.id === recordId);
            if (!recordToEdit) {
                showMessage('Record not found.', 'error');
                return;
            }

            currentEditingRecord = recordToEdit;
            updateFormFieldsForEntryType();

            dateInput.value = recordToEdit.date;
            challanNoInput.value = recordToEdit.challanNo;
            colorInput.value = recordToEdit.color || '';
            sizeInput.value = recordToEdit.size || '';
            qtyInput.value = recordToEdit.qty;
            rateInput.value = recordToEdit.rate;

            if (recordToEdit.type === 'Input') {
                inputBtn.click();
                skuInputText.value = recordToEdit.sku;
                vendorInputText.value = recordToEdit.vendorName;
            } else {
                outputBtn.click();
                // Logic to set dropdowns for output
                vendorSelectDropdown.value = recordToEdit.vendorName;
                handleVendorSelectChange();
                skuSelectDropdown.value = recordToEdit.sku;
                handleSkuSelectChange();
                challanSelectDropdown.value = recordToEdit.challanNo;
                handleChallanSelectChange();
            }
             document.querySelector('#materialForm button[type="submit"]').textContent = 'Update Record';
        };

        // Updates the vendor filter dropdown options
        const updateVendorFilterOptions = (records) => {
            const uniqueVendors = [...new Set(records.map(r => r.vendorName))].sort();
            vendorFilter.innerHTML = '<option value="all">All Vendors</option>';
            uniqueVendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor;
                option.textContent = vendor;
                vendorFilter.appendChild(option);
            });
            const currentFilter = vendorFilter.value;
            if (uniqueVendors.includes(currentFilter)) {
                vendorFilter.value = currentFilter;
            }
        };

        // Filters records based on user input (date, vendor, search)
        const filterRecords = () => {
            const selectedVendor = vendorFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const start = startDateInput.value ? new Date(startDateInput.value).setHours(0,0,0,0) : null;
            const end = endDateInput.value ? new Date(endDateInput.value).setHours(23,59,59,999) : null;

            let filteredRawRecords = allRecords.filter(record => {
                const recordDate = new Date(record.date).getTime();
                const matchesDate = (!start || recordDate >= start) && (!end || recordDate <= end);
                const matchesVendor = (selectedVendor === 'all' || record.vendorName === selectedVendor);
                const matchesSearch = (
                    record.challanNo.toLowerCase().includes(searchTerm) ||
                    record.sku.toLowerCase().includes(searchTerm) ||
                    record.vendorName.toLowerCase().includes(searchTerm) ||
                    record.color?.toLowerCase().includes(searchTerm) ||
                    record.type.toLowerCase().includes(searchTerm) ||
                    record.date.includes(searchTerm)
                );
                return matchesDate && matchesVendor && matchesSearch;
            });

            calculateAggregatedStock(filteredRawRecords);
            renderAggregatedRecordsTable(aggregatedStock);
        };

        // Deletes a record from Firestore
        const deleteRecord = async (recordId) => {
            // Using a custom modal would be better than confirm()
            if (window.confirm('Are you sure you want to delete this record? This action cannot be undone.')) {
                try {
                    if (!db || !userId) {
                        showMessage('Database not ready or user not logged in.', 'error', 'messageBox');
                        return;
                    }
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                    const appId = firebaseConfig.appId || 'default-app-id';
                    const recordRef = doc(db, `artifacts/${appId}/users/${userId}/material_records`, recordId);
                    await deleteDoc(recordRef);
                    showMessage('Record deleted successfully!', 'success', 'messageBox');
                } catch (error) {
                    console.error('Error deleting record:', error);
                    showMessage('Error deleting record', 'error', 'messageBox');
                }
            }
        };

        // Exports data to a CSV file
        const exportToCSV = () => {
            const headers = ['Date', 'Challan No', 'SKU', 'Color', 'Quantity', 'Rate', 'Value', 'Vendor Name', 'Type'];
            const csvContent = [
                headers.join(','),
                ...allRecords.map(record => [
                    record.date,
                    record.challanNo,
                    record.sku,
                    record.color || '',
                    record.qty,
                    record.rate,
                    (parseFloat(record.qty) * parseFloat(record.rate)).toFixed(2),
                    record.vendorName,
                    record.type
                ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `material_transactions_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        // Sets up the real-time Firestore listener
        const setupRealtimeListener = () => {
            if (!db || !userId) {
                console.log("Firestore or User ID not ready for listener setup. Retrying in 500ms.");
                setTimeout(setupRealtimeListener, 500);
                return;
            }

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = firebaseConfig.appId || 'default-app-id';
            const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/material_records`);
            const q = query(recordsCollectionRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                allRecords = [];
                snapshot.forEach((doc) => {
                    allRecords.push({ id: doc.id, ...doc.data() });
                });
                calculateAggregatedStock(allRecords);
                updateStatistics();
                updateVendorFilterOptions(allRecords);
                updateFormFieldsForEntryType();
                filterRecords();
            }, (error) => {
                console.error("Error fetching real-time updates:", error);
                showMessage('Error fetching records. Please refresh the page.', 'error', 'messageBox');
            });
        };

        // Helper function to create a dropdown select element dynamically
        const createSelectElement = (id, labelText, options, onChangeHandler, isRequired = false) => {
            const div = document.createElement('div');
            const label = document.createElement('label');
            label.htmlFor = id;
            label.className = 'form-label';
            label.innerHTML = `<i class="fas fa-${id.includes('vendor') ? 'store' : (id.includes('sku') ? 'barcode' : 'receipt')} mr-2"></i>${labelText}`;
            div.appendChild(label);

            const select = document.createElement('select');
            select.id = id;
            select.className = 'form-input';
            if (isRequired) select.required = true;
            select.addEventListener('change', onChangeHandler);

            options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                select.appendChild(option);
            });
            div.appendChild(select);
            return div;
        };

        // Updates the form fields based on the selected entry type (Input/Output)
        const updateFormFieldsForEntryType = () => {
            clearForm();
            
            // Get a reference to the form and its container
            const formGrid = document.getElementById('materialForm');
            formGrid.innerHTML = '';

            if (currentEntryType === 'Output') {
                const uniqueInputVendors = [...new Set(allRecords.filter(r => r.type === 'Input').map(r => r.vendorName))].sort();
                const vendorSelectDiv = createSelectElement('vendorSelect', 'Vendor Name', ['Select Vendor...', ...uniqueInputVendors], handleVendorSelectChange, true);

                const skuSelectDiv = createSelectElement('skuSelect', 'SKU', ['Select SKU...'], handleSkuSelectChange, true);

                const challanSelectDiv = createSelectElement('challanSelect', 'Challan No', ['Select Challan...'], handleChallanSelectChange, true);
                
                // Construct the HTML for the form fields in the desired order
                formGrid.innerHTML = `
                    <div id="vendorNameInputContainer"></div>
                    <div id="skuInputContainer"></div>
                    <div id="challanSelectContainer"></div>
                    <div>
                        <label for="date" class="form-label">
                            <i class="fas fa-calendar mr-2"></i>Date
                        </label>
                        <input type="date" id="date" class="form-input" required>
                    </div>
                    <div>
                        <label for="color" class="form-label">
                            <i class="fas fa-palette mr-2"></i>Color
                        </label>
                        <input type="text" id="color" class="form-input" placeholder="e.g., Blue" readonly>
                    </div>
                    <div>
                        <label for="size" class="form-label">
                            <i class="fas fa-ruler-horizontal mr-2"></i>Size
                        </label>
                        <input type="text" id="size" class="form-input" placeholder="e.g., S" readonly>
                    </div>
                    <div>
                        <label for="qty" class="form-label">
                            <i class="fas fa-sort-numeric-up mr-2"></i>Quantity
                        </label>
                        <input type="number" id="qty" class="form-input" min="1" required>
                    </div>
                    <div>
                        <label for="rate" class="form-label">
                            <i class="fas fa-rupee-sign mr-2"></i>Rate (per unit)
                        </label>
                        <input type="number" id="rate" class="form-input" step="0.01" min="0" readonly>
                    </div>
                    <div class="lg:col-span-3 flex justify-center mt-6">
                        <button type="submit" class="btn btn-primary text-lg px-8 py-4">
                            <i class="fas fa-save mr-2"></i>Add Record
                        </button>
                    </div>
                    <div id="messageBox" class="message-box hidden"></div>
                `;

                // Re-assign form elements after re-building the form
                vendorNameInputContainer = document.getElementById('vendorNameInputContainer');
                skuInputContainer = document.getElementById('skuInputContainer');
                challanSelectContainer = document.getElementById('challanSelectContainer');

                vendorNameInputContainer.appendChild(vendorSelectDiv);
                skuInputContainer.appendChild(skuSelectDiv);
                challanSelectContainer.appendChild(challanSelectDiv);
                
                vendorSelectDropdown = document.getElementById('vendorSelect');
                skuSelectDropdown = document.getElementById('skuSelect');
                challanSelectDropdown = document.getElementById('challanSelect');
                dateInput = document.getElementById('date');
                // challanNoInput is not used in output, it's replaced by challanSelectDropdown
                colorInput = document.getElementById('color');
                sizeInput = document.getElementById('size'); // Re-assign the new size input
                qtyInput = document.getElementById('qty');
                rateInput = document.getElementById('rate');

                skuInputText = null;
                vendorInputText = null;
                formTitle.innerHTML = '<i class="fas fa-minus mr-2"></i>Record Material Output';
                outputBtn.classList.add('active');
                outputBtn.classList.remove('inactive');
                inputBtn.classList.remove('active');
                inputBtn.classList.add('inactive');

                if (uniqueInputVendors.length === 0) {
                    showMessage('No input records found to select vendors/SKUs from for output.', 'error', 'messageBox');
                }
            } else { // Current Entry Type is 'Input'
                 formGrid.innerHTML = `
                    <div>
                        <label for="date" class="form-label">
                            <i class="fas fa-calendar mr-2"></i>Date
                        </label>
                        <input type="date" id="date" class="form-input" required>
                    </div>
                    <div>
                        <label for="challanNo" class="form-label">
                            <i class="fas fa-receipt mr-2"></i>Challan No
                        </label>
                        <input type="text" id="challanNo" class="form-input" placeholder="e.g., CHN-2025-001" required>
                    </div>
                    <div id="skuInputContainer">
                        <label for="sku" class="form-label">
                            <i class="fas fa-barcode mr-2"></i>SKU
                        </label>
                        <input type="text" id="sku" class="form-input" placeholder="e.g., BW6085BLUE_DRS-S" list="sku-datalist" required>
                        <datalist id="sku-datalist"></datalist>
                    </div>
                    <div>
                        <label for="color" class="form-label">
                            <i class="fas fa-palette mr-2"></i>Color
                        </label>
                        <input type="text" id="color" class="form-input" placeholder="e.g., Blue">
                    </div>
                    <div>
                        <label for="size" class="form-label">
                            <i class="fas fa-ruler-horizontal mr-2"></i>Size
                        </label>
                        <input type="text" id="size" class="form-input" placeholder="e.g., S">
                    </div>
                    <div>
                        <label for="qty" class="form-label">
                            <i class="fas fa-sort-numeric-up mr-2"></i>Quantity
                        </label>
                        <input type="number" id="qty" class="form-input" min="1" required>
                    </div>
                    <div>
                        <label for="rate" class="form-label">
                            <i class="fas fa-rupee-sign mr-2"></i>Rate (per unit)
                        </label>
                        <input type="number" id="rate" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div id="vendorNameInputContainer" class="lg:col-span-3">
                        <label for="vendorName" class="form-label">
                            <i class="fas fa-store mr-2"></i>Vendor Name
                        </label>
                        <input type="text" id="vendorName" class="form-input" placeholder="e.g., Myntra - SJIT" required>
                    </div>
                    <div id="challanSelectContainer" class="lg:col-span-3" style="display: none;">
                    </div>
                    <div class="lg:col-span-3 flex justify-center mt-6">
                        <button type="submit" class="btn btn-primary text-lg px-8 py-4">
                            <i class="fas fa-save mr-2"></i>Add Record
                        </button>
                    </div>
                    <div id="messageBox" class="message-box hidden"></div>
                `;
                
                // Re-assign form elements after re-building the form
                dateInput = document.getElementById('date');
                challanNoInput = document.getElementById('challanNo');
                colorInput = document.getElementById('color');
                sizeInput = document.getElementById('size'); // Re-assign the new size input
                qtyInput = document.getElementById('qty');
                rateInput = document.getElementById('rate');
                skuInputText = document.getElementById('sku');
                vendorInputText = document.getElementById('vendorName');
                
                vendorSelectDropdown = null;
                skuSelectDropdown = null;
                challanSelectDropdown = null;
                formTitle.innerHTML = '<i class="fas fa-plus mr-2"></i>Record New Material Input';
                inputBtn.classList.add('active');
                inputBtn.classList.remove('inactive');
                outputBtn.classList.remove('active');
                outputBtn.classList.add('inactive');
                
                // Populate the datalist with master SKUs if available
                const datalist = document.getElementById('sku-datalist');
                if (datalist) {
                    datalist.innerHTML = masterSKUs.map(sku => `<option value="${sku}">`).join('');
                }
                skuInputText.addEventListener('input', handleSkuInputLookup);
            }
            dateInput.value = new Date().toISOString().split('T')[0];
        };

        // Event handler for SKU input to auto-fill fields from previous records
        const handleSkuInputLookup = () => {
            const selectedSku = skuInputText.value;
            if (selectedSku) {
                // Find the latest record for this SKU
                const lastRecord = allRecords
                    .filter(r => r.sku === selectedSku && r.type === 'Input')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                
                if (lastRecord) {
                    colorInput.value = lastRecord.color || '';
                    sizeInput.value = lastRecord.size || ''; // Auto-fill the size
                    rateInput.value = parseFloat(lastRecord.rate).toFixed(2);
                    vendorInputText.value = lastRecord.vendorName;
                }
            }
        };

        // Event handler for when the vendor dropdown changes (for Output)
        const handleVendorSelectChange = () => {
            const selectedVendor = vendorSelectDropdown.value;
            const skuOptions = ['Select SKU...'];
            if (selectedVendor !== 'Select Vendor...') {
                const uniqueSkusForVendor = [...new Set(
                    allRecords
                        .filter(r => r.type === 'Input' && r.vendorName === selectedVendor)
                        .map(r => r.sku)
                )].sort();
                skuOptions.push(...uniqueSkusForVendor);
            }

            skuSelectDropdown.innerHTML = '';
            skuOptions.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                skuSelectDropdown.appendChild(option);
            });
            skuSelectDropdown.value = 'Select SKU...';

            // Reset other fields
            if (challanSelectDropdown) challanSelectDropdown.innerHTML = '<option value="Select Challan...">Select Challan...</option>';
            challanSelectContainer.style.display = 'none';
            if (colorInput) colorInput.value = '';
            if (sizeInput) sizeInput.value = ''; // Reset size
            if (qtyInput) qtyInput.value = '';
            if (rateInput) rateInput.value = '';
            if (qtyInput) qtyInput.max = '';
        };

        // Event handler for when the SKU dropdown changes (for Output)
        const handleSkuSelectChange = () => {
            const selectedSku = skuSelectDropdown.value;
            const selectedVendor = vendorSelectDropdown.value;
            const challanOptions = ['Select Challan...'];

            if (selectedSku !== 'Select SKU...' && selectedVendor !== 'Select Vendor...') {
                const uniqueChallansForSku = [...new Set(
                    allRecords
                        .filter(r => r.type === 'Input' && r.vendorName === selectedVendor && r.sku === selectedSku)
                        .map(r => r.challanNo)
                )].sort();
                challanOptions.push(...uniqueChallansForSku);
                challanSelectContainer.style.display = 'block';
            } else {
                challanSelectContainer.style.display = 'none';
            }

            challanSelectDropdown.innerHTML = '';
            challanOptions.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                challanSelectDropdown.appendChild(option);
            });
            challanSelectDropdown.value = 'Select Challan...';

            // Reset other fields
            if (colorInput) colorInput.value = '';
            if (sizeInput) sizeInput.value = ''; // Reset size
            if (qtyInput) qtyInput.value = '';
            if (rateInput) rateInput.value = '';
            if (qtyInput) qtyInput.max = '';
        };

        // Event handler for when the Challan dropdown changes (for Output)
        const handleChallanSelectChange = () => {
            const selectedSku = skuSelectDropdown.value;
            const selectedVendor = vendorSelectDropdown.value;
            const selectedChallan = challanSelectDropdown.value;

            if (selectedSku !== 'Select SKU...' && selectedVendor !== 'Select Vendor...' && selectedChallan !== 'Select Challan...') {
                const relevantInputRecords = allRecords.filter(r => r.type === 'Input' && r.sku === selectedSku && r.vendorName === selectedVendor && r.challanNo === selectedChallan);
                
                if (relevantInputRecords.length > 0) {
                    const latestInputRecord = relevantInputRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

                    const inputQtyForChallan = relevantInputRecords.reduce((sum, r) => sum + r.qty, 0);
                    const outputQtyFromThisChallan = allRecords
                        .filter(r => r.type === 'Output' && r.sku === selectedSku && r.color === latestInputRecord.color && r.challanNo === selectedChallan)
                        .reduce((sum, r) => sum + r.qty, 0);

                    const availableQty = inputQtyForChallan - outputQtyFromThisChallan;

                    if (colorInput) colorInput.value = latestInputRecord.color || '';
                    if (sizeInput) sizeInput.value = latestInputRecord.size || ''; // Fetch and display the size
                    if (rateInput) rateInput.value = parseFloat(latestInputRecord.rate).toFixed(2);
                    
                    if (qtyInput) qtyInput.value = availableQty > 0 ? availableQty : 0;
                    if (qtyInput) qtyInput.max = availableQty;
                    if (qtyInput) qtyInput.min = 1;
                    showMessage(`Available stock for this challan: ${availableQty}`, 'success', 'messageBox');
                } else {
                    if (colorInput) colorInput.value = '';
                    if (sizeInput) sizeInput.value = ''; // Clear size
                    if (qtyInput) qtyInput.value = '';
                    if (rateInput) rateInput.value = '';
                    if (qtyInput) qtyInput.max = '';
                    showMessage('No matching input record found for this Challan.', 'error', 'messageBox');
                }
            } else {
                if (colorInput) colorInput.value = '';
                if (sizeInput) sizeInput.value = ''; // Clear size
                if (qtyInput) qtyInput.value = '';
                if (rateInput) rateInput.value = '';
                if (qtyInput) qtyInput.max = '';
            }
        };

        // Updates the file status message
        const updateFileStatus = () => {
            if (masterSKUs.length > 0) {
                fileStatus.textContent = `Master SKU list loaded.`;
                fileStatus.classList.remove('text-gray-400', 'text-red-400');
                fileStatus.classList.add('text-green-400');
            } else {
                fileStatus.textContent = 'No master SKU list loaded. Please upload a file.';
                fileStatus.classList.remove('text-gray-400', 'text-green-400');
                fileStatus.classList.add('text-red-400');
            }
        };

        // Handles local CSV file upload
        const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) {
                fileStatus.textContent = 'No file selected.';
                masterSKUs = [];
                updateFormFieldsForEntryType();
                return;
            }
            fileStatus.textContent = `Reading ${file.name}...`;

            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                const lines = text.split('\n');
                const skus = lines.slice(1).map(line => line.split(',')[0].trim()).filter(sku => sku);
                masterSKUs = [...new Set(skus)].sort();
                updateFormFieldsForEntryType(); // Re-render the form with new datalist options
                updateFileStatus();
            };
            reader.onerror = (error) => {
                console.error('Error reading file:', error);
                fileStatus.textContent = 'Error reading file.';
                showMessage('Error reading file. Please try again.', 'error');
                masterSKUs = [];
                updateFileStatus();
            };
            reader.readAsText(file);
        };
        
        masterSkuFile.addEventListener('change', handleFileUpload);
        
        // Event listeners for the input/output toggle buttons
        inputBtn.addEventListener('click', () => {
            currentEntryType = 'Input';
            updateFormFieldsForEntryType();
        });

        outputBtn.addEventListener('click', () => {
            currentEntryType = 'Output';
            updateFormFieldsForEntryType();
        });

        // Event listener for the material form submission
        materialForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log("Form submit attempt. currentUser:", currentUser, "userId:", userId);

            if (!db || !userId) {
                showMessage('Database is not initialized or user ID is missing. Please refresh and try again.', 'error', 'messageBox');
                console.error("Attempted to add record but db or userId is missing. db:", db, "userId:", userId);
                return;
            }

            let record = {};
            record.date = dateInput.value;
            if (challanNoInput) record.challanNo = challanNoInput.value.trim();
            if (colorInput) record.color = colorInput.value.trim();
            if (sizeInput) record.size = sizeInput.value.trim(); // Get the size value
            if (qtyInput) record.qty = parseInt(qtyInput.value);
            if (rateInput) record.rate = parseFloat(rateInput.value);
            record.timestamp = new Date().toISOString();

            if (currentEntryType === 'Input') {
                record.type = 'Input';
                record.sku = skuInputText.value.trim();
                record.vendorName = vendorInputText.value.trim();
            } else {
                record.type = 'Output';

                if (!skuSelectDropdown || !vendorSelectDropdown || !challanSelectDropdown) {
                     showMessage('SKU, Vendor, or Challan dropdown not found. Please try switching tabs.', 'error', 'messageBox');
                    console.error("Output dropdowns (SKU, Vendor, or Challan) are null during form submission.");
                    return;
                }

                record.sku = skuSelectDropdown.value;
                record.vendorName = vendorSelectDropdown.value;
                record.challanNo = challanSelectDropdown.value;
                
                // Get the rate and color and size from the selected input record
                const selectedInputRecord = allRecords.find(r => r.type === 'Input' && r.challanNo === record.challanNo && r.sku === record.sku && r.vendorName === record.vendorName);
                if (selectedInputRecord) {
                    record.rate = selectedInputRecord.rate;
                    record.color = selectedInputRecord.color;
                    record.size = selectedInputRecord.size; // Get the size from the input record
                } else {
                    showMessage('Cannot find a matching input record to determine rate, color and size.', 'error', 'messageBox');
                    return;
                }
            }

            if (!record.date || !record.challanNo || !record.sku || isNaN(record.qty) || isNaN(record.rate) || !record.vendorName ||
                record.sku === 'Select SKU...' || record.vendorName === 'Select Vendor...' || (currentEntryType === 'Output' && record.challanNo === 'Select Challan...')) {
                showMessage('Please fill in all required fields and make valid selections.', 'error', 'messageBox');
                return;
            }
            if (record.qty <= 0 || record.rate < 0) {
                showMessage('Quantity must be positive and Rate cannot be negative.', 'error', 'messageBox');
                return;
            }

            if (currentEntryType === 'Output') {
                const availableQty = parseFloat(qtyInput.max);

                if (record.qty > availableQty) {
                    showMessage(`Output quantity (${record.qty}) exceeds available stock (${availableQty}) from this challan for ${record.sku} (${record.color}).`, 'error', 'messageBox');
                    return;
                }
            }

            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const appId = firebaseConfig.appId || 'default-app-id';
                const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/material_records`);
                
                if (currentEditingRecord) {
                     // Update existing record
                     const docRef = doc(db, `artifacts/${appId}/users/${userId}/material_records`, currentEditingRecord.id);
                     await updateDoc(docRef, record);
                     showMessage('Record updated successfully!', 'success', 'messageBox');
                } else {
                     // Add new record
                     await addDoc(recordsCollectionRef, record);
                     showMessage('Record added successfully!', 'success', 'messageBox');
                }

                clearForm();
                updateFormFieldsForEntryType();
            } catch (error) {
                console.error('Error adding/updating record:', error);
                showMessage('Error adding/updating record. Please try again.', 'error', 'messageBox');
            }
        });

        // Event listeners for filtering and export functions
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        vendorFilter.addEventListener('change', filterRecords);
        searchInput.addEventListener('input', filterRecords);
        startDateInput.addEventListener('change', filterRecords);
        endDateInput.addEventListener('change', filterRecords);
        exportBtn.addEventListener('click', exportToCSV);
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }

        // Expose the deleteRecord function to the global scope for the table action buttons
        window.deleteRecord = deleteRecord;
        window.editRecord = editRecord;

        // Main entry point for the application, runs once the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupLoginListeners();
        });
    </script>
</body>
</html>
