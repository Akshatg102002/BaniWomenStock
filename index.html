<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Record System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #000000 100%);
            min-height: 100vh;
            color: #ffffff;
            margin: 0;
            padding: 0;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .form-input {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #333333;
            border-radius: 0.75rem;
            background-color: #1a1a1a;
            color: #ffffff;
            transition: all 0.2s ease-in-out;
            outline: none;
        }

        .form-input:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .form-input::placeholder {
            color: #666666;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
            background-color: #f0f0f0;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ffffff, #e0e0e0);
            color: #000000;
        }

        .btn-secondary {
            background: #333333;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #555555;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .btn-danger:hover {
            background: #dc2626;
            color: #ffffff;
        }

        .btn-success {
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            color: #059669;
            border: 1px solid #059669;
        }

        .btn-success:hover {
            background: #059669;
            color: #ffffff;
        }

        .btn-toggle {
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.125rem;
            transition: all 0.3s ease-in-out;
            border: 2px solid transparent;
        }

        .btn-toggle.active {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .btn-toggle.inactive {
            background: transparent;
            color: #ffffff;
            border-color: #333333;
        }

        .btn-toggle.inactive:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ffffff;
        }

        .login-container {
            max-width: 400px;
            margin: 10vh auto;
            padding: 2rem;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: #ffffff;
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
            border: 1px solid #333333;
        }

        .stats-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #333333;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #ffffff;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 255, 255, 0.1);
        }

        .stats-card.input::before {
            background: #10b981;
        }

        .stats-card.output::before {
            background: #ef4444;
        }

        .stats-card.total::before {
            background: #3b82f6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #000000;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #333333;
        }

        th {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #333333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            color: #ffffff;
            border-bottom: 1px solid #1a1a1a;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease;
        }
        
        .message-box {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .message-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .message-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .loading-spinner {
            border: 3px solid #333333;
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 0.75rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: #ffffff;
            color: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .export-btn {
            background: #059669;
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }

        .export-btn:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding-left: 2.5rem;
            padding-right: 1rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            border: 2px solid #333333;
            border-radius: 0.75rem;
            width: 100%;
            background: #1a1a1a;
            color: #ffffff;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: #ffffff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666666;
        }

        .hidden {
            display: none !important;
        }

        .form-section {
            background: rgba(26, 26, 26, 0.8);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid #333333;
        }

        .line-clamp-1 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            overflow: hidden;
        }

        .scrollable-remarks {
            max-width: 150px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .status-output {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-issue {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .delete-btn, .edit-btn, .print-btn {
            font-size: 1rem;
            transition: color 0.2s ease;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.5rem;
        }

        .delete-btn { color: #ef4444; }
        .delete-btn:hover { color: #dc2626; }
        .edit-btn { color: #3b82f6; }
        .edit-btn:hover { color: #2563eb; }
        .print-btn { color: #059669; }
        .print-btn:hover { color: #047857; }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media print {
            body > *:not(.print-challan) {
                display: none;
            }
            .print-challan {
                display: block;
                width: 100%;
                margin: 0;
                padding: 0;
                font-family: 'Arial', sans-serif;
                color: #000;
                background-color: #fff;
            }
            .print-challan-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .print-challan-table th, .print-challan-table td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
                font-size: 12px;
            }
            .no-border td {
                border: none !important;
            }
        }
    </style>
</head>
<body>
    <script>
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyCZV-AReOyDWnmnhIKgDvmpUlO8GdJ6xWg",
            authDomain: "bani-40b68.firebaseapp.com",
            projectId: "bani-40b68",
            storageBucket: "bani-40b68.firebasestorage.app",
            messagingSenderId: "971923274030",
            appId: "1:971923274030:web:f122e5b124d08fc44a62bf",
            measurementId: "G-2WNYB3WNNY"
        });
    </script>

    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="login-container glass-morphism rounded-2xl fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 mx-auto">
                    <i class="fas fa-boxes text-black text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Material Record System</h1>
                <p class="text-gray-400">Secure inventory management</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="form-label"><i class="fas fa-user mr-2"></i>Username</label>
                    <input type="text" id="username" class="form-input" placeholder="Enter your username" required>
                </div>
                <div>
                    <label for="password" class="form-label"><i class="fas fa-lock mr-2"></i>Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary w-full"><i class="fas fa-sign-in-alt mr-2"></i>Sign In</button>
                <div class="text-center">
                    <button type="button" id="demoLoginBtn" class="text-white hover:text-gray-300 font-medium" style="background: none; border: none; cursor: pointer;">
                        <i class="fas fa-play mr-1"></i>Try Demo Account
                    </button>
                </div>
            </form>
            <div id="loginMessage" class="message-box hidden"></div>
        </div>
    </div>

    <div id="mainDashboard" class="hidden min-h-screen">
        <div class="container">
            <div class="dashboard-header rounded-2xl mb-8 fade-in">
                <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-4xl font-bold mb-2"><i class="fas fa-warehouse mr-3"></i>Material Record System</h1>
                        <p class="text-gray-300">Advanced inventory management dashboard</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="user-profile">
                            <div class="avatar" id="userAvatar">U</div>
                            <div>
                                <div class="font-semibold" id="userDisplayName">User</div>
                                <div class="text-sm text-gray-300" id="userIdDisplay">Loading...</div>
                            </div>
                        </div>
                        <button id="logoutBtn" class="btn btn-danger"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stats-card output">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Output</p>
                            <p class="text-2xl font-bold text-green-400" id="totalInput">0</p>
                        </div>
                        <div class="text-green-400 text-3xl"><i class="fas fa-arrow-down"></i></div>
                    </div>
                </div>
                <div class="stats-card input">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Total Issued</p>
                            <p class="text-2xl font-bold text-red-400" id="totalOutput">0</p>
                        </div>
                        <div class="text-red-400 text-3xl"><i class="fas fa-arrow-up"></i></div>
                    </div>
                </div>
                <div class="stats-card total">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-400">Current Stock</p>
                            <p class="text-2xl font-bold text-blue-400" id="currentStock">0</p>
                        </div>
                        <div class="text-blue-400 text-3xl"><i class="fas fa-boxes"></i></div>
                    </div>
                </div>
            </div>

            <div class="glass-morphism rounded-2xl p-8 mb-8 fade-in">
                <div class="flex justify-center gap-6 mb-8">
                    <button id="inputBtn" class="btn-toggle active"><i class="fas fa-plus mr-2"></i>Output Material</button>
                    <button id="outputBtn" class="btn-toggle inactive"><i class="fas fa-minus mr-2"></i>Issue Material</button>
                </div>
                <div class="form-section">
                    <h2 id="formTitle" class="text-2xl font-bold text-white mb-6 text-center"><i class="fas fa-edit mr-2"></i>Record Output Material</h2>
                    <form id="materialForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="date" class="form-label"><i class="fas fa-calendar mr-2"></i>Date</label>
                            <input type="date" id="date" class="form-input" required>
                        </div>
                        <div>
                            <label for="challanNo" class="form-label"><i class="fas fa-receipt mr-2"></i>Challan No</label>
                            <input type="text" id="challanNo" class="form-input" placeholder="e.g., CHN-2025-001" required>
                        </div>
                        <div id="skuInputContainer"></div>
                        <div>
                            <label for="color" class="form-label"><i class="fas fa-palette mr-2"></i>Color</label>
                            <input type="text" id="color" class="form-input" placeholder="e.g., Blue">
                        </div>
                        <div>
                            <label for="qty" class="form-label"><i class="fas fa-sort-numeric-up mr-2"></i>Quantity</label>
                            <input type="number" id="qty" class="form-input" min="1" required>
                        </div>
                        <div>
                            <label for="rate" class="form-label"><i class="fas fa-rupee-sign mr-2"></i>Rate (per unit)</label>
                            <input type="number" id="rate" class="form-input" step="0.01" min="0" required>
                        </div>
                        <div id="vendorInputContainer" class="lg:col-span-3"></div>
                        <div>
                            <label for="remarks" class="form-label"><i class="fas fa-sticky-note mr-2"></i>Remarks</label>
                            <textarea id="remarks" class="form-input" placeholder="e.g., Damaged item, Urgent order, etc." rows="4"></textarea>
                        </div>
                        <div id="challanSelectContainer" class="lg:col-span-3" style="display: none;"></div>
                        <div class="lg:col-span-3 flex justify-center flex-col md:flex-row gap-4 mt-6">
                            <button type="submit" class="btn btn-primary text-lg px-8 py-4"><i class="fas fa-save mr-2"></i>Add Record</button>
                            <button type="button" id="printChallanBtn" class="btn btn-primary text-lg px-8 py-4"><i class="fas fa-print mr-2"></i>Print Challan</button>
                        </div>
                    </form>
                    <div id="messageBox" class="message-box hidden"></div>
                </div>
            </div>

            <div class="glass-morphism rounded-2xl p-8 fade-in">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <h2 class="text-3xl font-bold text-white"><i class="fas fa-table mr-3"></i>Stock</h2>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <div>
                                <label for="startDate" class="form-label hidden sm:block">Start Date</label>
                                <input type="date" id="startDate" class="form-input w-full sm:w-auto">
                            </div>
                            <div>
                                <label for="endDate" class="form-label hidden sm:block">End Date</label>
                                <input type="date" id="endDate" class="form-input w-full sm:w-auto">
                            </div>
                        </div>
                        <select id="vendorFilter" class="form-input w-full sm:w-auto"><option value="all">All Vendors</option></select>
                        <div class="search-box w-full sm:w-auto">
                            <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <button id="exportBtn" class="export-btn w-full sm:w-auto"><i class="fas fa-download"></i>Export CSV</button>
                    </div>
                </div>
                <div class="overflow-x-auto mb-12 h-[300px] overflow-y-auto rounded-lg shadow-lg">
                    <table id="aggregatedRecordsTable" class="w-full">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-barcode mr-2"></i>SKU</th>
                                <th scope="col"><i class="fas fa-palette mr-2"></i>Color</th>
                                <th scope="col"><i class="fas fa-receipt mr-2"></i>Challan No</th>
                                <th scope="col"><i class="fas fa-store mr-2"></i>Vendor</th>
                                <th scope="col"><i class="fas fa-rupee-sign mr-2"></i>Latest Rate</th>
                                <th scope="col"><i class="fas fa-arrow-down mr-2"></i>Total Output Qty</th>
                                <th scope="col"><i class="fas fa-arrow-up mr-2"></i>Total Issued Qty</th>
                                <th scope="col"><i class="fas fa-boxes mr-2"></i>Remaining Stock</th>
                            </tr>
                        </thead>
                        <tbody id="aggregatedRecordsTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Loading records...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h2 class="text-3xl font-bold text-white mb-6 text-center"><i class="fas fa-history mr-3"></i>Transactions</h2>
                <div class="overflow-x-auto h-[400px] overflow-y-auto rounded-lg shadow-lg">
                    <table id="transactionTable" class="w-full">
                        <thead>
                            <tr>
                                <th scope="col"><i class="fas fa-calendar mr-2"></i>Date</th>
                                <th scope="col"><i class="fas fa-receipt mr-2"></i>Challan No</th>
                                <th scope="col"><i class="fas fa-barcode mr-2"></i>SKU</th>
                                <th scope="col"><i class="fas fa-palette mr-2"></i>Color</th>
                                <th scope="col"><i class="fas fa-sort-numeric-up mr-2"></i>Qty</th>
                                <th scope="col"><i class="fas fa-rupee-sign mr-2"></i>Rate</th>
                                <th scope="col"><i class="fas fa-calculator mr-2"></i>Value</th>
                                <th scope="col"><i class="fas fa-store mr-2"></i>Vendor</th>
                                <th scope="col" style="max-width: 150px;"><i class="fas fa-sticky-note mr-2"></i>Remarks</th>
                                <th scope="col"><i class="fas fa-tag mr-2"></i>Type</th>
                                <th scope="col"><i class="fas fa-cog mr-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <tr>
                                <td colspan="11" class="text-center py-8 text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Loading transactions...</td>
                            </tr>
                        </tbody>
                        <tfoot id="transactionTableFooter">
                            <tr class="bg-gray-900 font-bold">
                                <td colspan="4" class="text-right">Totals:</td>
                                <td id="totalOutputQty" class="text-green-400">0</td>
                                <td id="totalIssuedQty" class="text-red-400">0</td>
                                <td id="totalRemainingStock" class="text-blue-400">0</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="glass-morphism rounded-2xl p-8 w-11/12 max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold"><i class="fas fa-edit mr-2"></i>Edit Record</h2>
                <button id="closeEditModalBtn" class="text-white text-2xl hover:text-gray-400">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <input type="hidden" id="editRecordId">
                <div>
                    <label for="editDate" class="form-label"><i class="fas fa-calendar mr-2"></i>Date</label>
                    <input type="date" id="editDate" class="form-input" required>
                </div>
                <div>
                    <label for="editChallanNo" class="form-label"><i class="fas fa-receipt mr-2"></i>Challan No</label>
                    <input type="text" id="editChallanNo" class="form-input" required>
                </div>
                <div>
                    <label for="editSku" class="form-label"><i class="fas fa-barcode mr-2"></i>SKU</label>
                    <input type="text" id="editSku" class="form-input" required>
                </div>
                <div>
                    <label for="editColor" class="form-label"><i class="fas fa-palette mr-2"></i>Color</label>
                    <input type="text" id="editColor" class="form-input">
                </div>
                <div>
                    <label for="editQty" class="form-label"><i class="fas fa-sort-numeric-up mr-2"></i>Quantity</label>
                    <input type="number" id="editQty" class="form-input" required>
                </div>
                <div>
                    <label for="editRate" class="form-label"><i class="fas fa-rupee-sign mr-2"></i>Rate (per unit)</label>
                    <input type="number" id="editRate" class="form-input" step="0.01" min="0" required>
                </div>
                <div>
                    <label for="editVendorName" class="form-label"><i class="fas fa-store mr-2"></i>Vendor Name</label>
                    <input type="text" id="editVendorName" class="form-input" required>
                </div>
                <div class="lg:col-span-3">
                    <label for="editRemarks" class="form-label"><i class="fas fa-sticky-note mr-2"></i>Remarks</label>
                    <textarea id="editRemarks" class="form-input" rows="2"></textarea>
                </div>
                <div class="lg:col-span-3 flex justify-center gap-4 mt-6">
                    <button type="submit" class="btn btn-success text-lg px-8 py-4"><i class="fas fa-save mr-2"></i>Save Changes</button>
                    <button type="button" id="cancelEditBtn" class="btn btn-secondary text-lg px-8 py-4"><i class="fas fa-times mr-2"></i>Cancel</button>
                </div>
            </form>
            <div id="editMessage" class="message-box hidden mt-4"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        let app;
        let db;
        let userId = null;
        const users = {
            'admin': { password: 'admin123', name: 'Administrator', id: 'admin_001' },
            'user': { password: 'user123', name: 'Standard User', id: 'user_001' },
            'demo': { password: 'demo', name: 'Demo User', id: 'demo_001' },
            'Manish': { password: 'Manish@Bani999', name: 'Manish', id: 'manish_user_id' }
        };
        let currentUser = null;
        let allRecords = [];
        let aggregatedStock = {};
        let currentEntryType = 'Input';

        const loginScreen = document.getElementById('loginScreen');
        const mainDashboard = document.getElementById('mainDashboard');
        const loginForm = document.getElementById('loginForm');
        const demoLoginBtn = document.getElementById('demoLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userDisplayName = document.getElementById('userDisplayName');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');

        const inputBtn = document.getElementById('inputBtn');
        const outputBtn = document.getElementById('outputBtn');
        const formTitle = document.getElementById('formTitle');
        const materialForm = document.getElementById('materialForm');
        const messageBox = document.getElementById('messageBox');
        const aggregatedRecordsTableBody = document.getElementById('aggregatedRecordsTableBody');
        const transactionTableBody = document.getElementById('transactionTableBody');
        const vendorFilter = document.getElementById('vendorFilter');
        const searchInput = document.getElementById('searchInput');
        const exportBtn = document.getElementById('exportBtn');
        const printChallanBtn = document.getElementById('printChallanBtn');

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        let dateInput = document.getElementById('date');
        let challanNoInput = document.getElementById('challanNo');
        let colorInput = document.getElementById('color');
        let qtyInput = document.getElementById('qty');
        let rateInput = document.getElementById('rate');
        let remarksInput = document.getElementById('remarks');

        const skuInputContainer = document.getElementById('skuInputContainer');
        const vendorInputContainer = document.getElementById('vendorInputContainer');
        const challanSelectContainer = document.getElementById('challanSelectContainer');

        let skuInputText = null;
        let vendorInputText = null;
        let vendorSelectDropdown = null;
        let skuSelectDropdown = null;
        let challanSelectDropdown = null;

        const totalInputDisplay = document.getElementById('totalInput');
        const totalOutputDisplay = document.getElementById('totalOutput');
        const currentStockDisplay = document.getElementById('currentStock');

        const editModal = document.getElementById('editModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const editForm = document.getElementById('editForm');
        const editRecordIdInput = document.getElementById('editRecordId');
        const editDateInput = document.getElementById('editDate');
        const editChallanNoInput = document.getElementById('editChallanNo');
        const editSkuInput = document.getElementById('editSku');
        const editColorInput = document.getElementById('editColor');
        const editQtyInput = document.getElementById('editQty');
        const editRateInput = document.getElementById('editRate');
        const editVendorNameInput = document.getElementById('editVendorName');
        const editRemarksInput = document.getElementById('editRemarks');
        const editMessage = document.getElementById('editMessage');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const transactionTableFooter = document.getElementById('transactionTableFooter');
        const totalOutputQtyFooter = document.getElementById('totalOutputQty');
        const totalIssuedQtyFooter = document.getElementById('totalIssuedQty');
        const totalRemainingStockFooter = document.getElementById('totalRemainingStock');

        const initializeFirebase = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                if (!firebaseConfig.projectId) {
                    console.error("Firebase 'projectId' not provided in __firebase_config.");
                    showMessage('Firebase configuration error: Project ID missing.', 'error');
                    showLogin();
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase Firestore initialized.");

                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        userId = currentUser.id;
                        console.log("Loaded user from localStorage:", currentUser);
                        showDashboard();
                    } catch (error) {
                        console.error('Error parsing saved user from localStorage:', error);
                        localStorage.removeItem('currentUser');
                        showLogin();
                    }
                } else {
                    console.log("No user found in localStorage. Showing login screen.");
                    showLogin();
                }
            } catch (error) {
                console.error("Error initializing Firebase Firestore:", error);
                showMessage('Error initializing application. Please try again.', 'error');
                userIdDisplay.textContent = 'Error';
                showLogin();
            }
        };

        const showMessage = (message, type, elementId = 'messageBox') => {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message-box ${type === 'success' ? 'message-success' : 'message-error'}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        };

        const handleLogin = (username, password) => {
            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                userId = currentUser.id;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log("Login successful. currentUser:", currentUser, "userId:", userId);
                showDashboard();
                showMessage('Login successful!', 'success', 'loginMessage');
                return true;
            }
            console.log("Login failed for username:", username);
            return false;
        };

        const logout = () => {
            currentUser = null;
            userId = null;
            localStorage.removeItem('currentUser');
            showLogin();
        };

        const showLogin = () => {
            loginScreen.classList.remove('hidden');
            mainDashboard.classList.add('hidden');
        };

        const showDashboard = () => {
            loginScreen.classList.add('hidden');
            mainDashboard.classList.remove('hidden');
            userDisplayName.textContent = currentUser.name;
            userIdDisplay.textContent = currentUser.id;
            userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();

            if (userId && db) {
                setupRealtimeListener();
                addDemoData();
            } else {
                console.error("Cannot setup dashboard: userId or db is not ready.");
                showMessage("Dashboard data could not be loaded. Please re-login.", "error");
                showLogin();
            }
        };

        const clearForm = () => {
            dateInput.value = new Date().toISOString().split('T')[0];
            challanNoInput.value = '';
            colorInput.value = '';
            qtyInput.value = '';
            rateInput.value = '';
            remarksInput.value = '';
            if (document.getElementById('sku')) document.getElementById('sku').value = '';
            if (document.getElementById('vendorName')) document.getElementById('vendorName').value = '';
            if (document.getElementById('vendorSelect')) document.getElementById('vendorSelect').value = 'Select Vendor...';
            if (document.getElementById('skuSelect')) document.getElementById('skuSelect').innerHTML = '<option value="Select SKU...">Select SKU...</option>';
            if (document.getElementById('challanSelect')) document.getElementById('challanSelect').innerHTML = '<option value="Select Challan...">Select Challan...</option>';
            challanSelectContainer.style.display = 'none';
        };

        const updateStatistics = () => {
            let totalInputQty = 0;
            let totalOutputQty = 0;
            for (const key in aggregatedStock) {
                totalInputQty += aggregatedStock[key].inputQty;
                totalOutputQty += aggregatedStock[key].outputQty;
            }
            const stockQty = totalInputQty - totalOutputQty;
            totalInputDisplay.textContent = totalInputQty.toLocaleString();
            totalOutputDisplay.textContent = totalOutputQty.toLocaleString();
            currentStockDisplay.textContent = stockQty.toLocaleString();
        };

        const calculateAggregatedStock = (records) => {
            const tempAggregatedStock = {};
            records.forEach(record => {
                const key = `${record.sku}-${record.color}`;
                if (!tempAggregatedStock[key]) {
                    tempAggregatedStock[key] = {
                        sku: record.sku,
                        color: record.color,
                        challanNo: '',
                        vendorName: '',
                        latestRate: 0,
                        inputQty: 0,
                        outputQty: 0,
                        timestamp: null
                    };
                }
                if (record.type === 'Input') {
                    tempAggregatedStock[key].inputQty += record.qty;
                    if (!tempAggregatedStock[key].timestamp || new Date(record.timestamp) > new Date(tempAggregatedStock[key].timestamp)) {
                        tempAggregatedStock[key].latestRate = record.rate;
                        tempAggregatedStock[key].vendorName = record.vendorName;
                        tempAggregatedStock[key].challanNo = record.challanNo;
                        tempAggregatedStock[key].timestamp = record.timestamp;
                    }
                } else if (record.type === 'Output') {
                    tempAggregatedStock[key].outputQty += record.qty;
                }
            });
            aggregatedStock = tempAggregatedStock;
        };

        const renderAggregatedRecordsTable = (stockToDisplay) => {
            aggregatedRecordsTableBody.innerHTML = '';
            if (Object.keys(stockToDisplay).length === 0) {
                aggregatedRecordsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-4 block"></i>No records found.</td></tr>`;
                return;
            }
            const sortedStock = Object.values(stockToDisplay).sort((a, b) => {
                if (a.sku < b.sku) return -1;
                if (a.sku > b.sku) return 1;
                if (a.color < b.color) return -1;
                if (a.color > b.color) return 1;
                return 0;
            });
            sortedStock.forEach(item => {
                const remaining = item.inputQty - item.outputQty;
                const row = aggregatedRecordsTableBody.insertRow();
                row.innerHTML = `
                    <td><span style="font-family: monospace; font-size: 0.75rem;">${item.sku}</span></td>
                    <td>${item.color || 'N/A'}</td>
                    <td>${item.challanNo || 'N/A'}</td>
                    <td>${item.vendorName}</td>
                    <td>₹${parseFloat(item.latestRate).toFixed(2)}</td>
                    <td class="font-semibold text-green-400">${item.inputQty.toLocaleString()}</td>
                    <td class="font-semibold text-red-400">${item.outputQty.toLocaleString()}</td>
                    <td class="font-bold ${remaining < 0 ? 'text-red-500' : 'text-blue-400'}">${remaining.toLocaleString()}</td>
                `;
            });
        };

        const renderTransactionTable = (recordsToDisplay) => {
            transactionTableBody.innerHTML = '';
            let totalInputQty = 0;
            let totalOutputQty = 0;
            if (recordsToDisplay.length === 0) {
                transactionTableBody.innerHTML = `<tr><td colspan="11" class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-4 block"></i>No transactions found.</td></tr>`;
                totalOutputQtyFooter.textContent = '0';
                totalIssuedQtyFooter.textContent = '0';
                totalRemainingStockFooter.textContent = '0';
                return;
            }
            const sortedRecords = recordsToDisplay.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            sortedRecords.forEach(record => {
                const row = transactionTableBody.insertRow();
                const value = parseFloat(record.qty) * parseFloat(record.rate);
                const typeLabel = record.type === 'Input' ? 'Output' : 'Issue';
                if (record.type === 'Input') {
                    totalInputQty += record.qty;
                } else {
                    totalOutputQty += record.qty;
                }
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span style="font-family: monospace; font-size: 0.75rem; background: #333; color: #fff; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${record.challanNo}</span></td>
                    <td><span style="font-family: monospace; font-size: 0.75rem;">${record.sku}</span></td>
                    <td>${record.color || 'N/A'}</td>
                    <td class="font-semibold">${parseInt(record.qty).toLocaleString()}</td>
                    <td>₹${parseFloat(record.rate).toFixed(2)}</td>
                    <td class="font-bold">₹${Number(value).toLocaleString()}</td>
                    <td>${record.vendorName}</td>
                    <td><div class="scrollable-remarks" title="${record.remarks || ''}">${record.remarks || ''}</div></td>
                    <td><span class="${record.type === 'Input' ? 'status-output' : 'status-issue'}">${typeLabel}</span></td>
                    <td class="flex items-center gap-2">
                        <button onclick="editRecord('${record.id}')" class="edit-btn"><i class="fas fa-edit"></i></button>
                        <button onclick="printChallanFromRecord('${record.id}')" class="print-btn"><i class="fas fa-print"></i></button>
                        <button onclick="deleteRecord('${record.id}')" class="delete-btn"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });

            totalOutputQtyFooter.textContent = totalInputQty.toLocaleString();
            totalIssuedQtyFooter.textContent = totalOutputQty.toLocaleString();
            totalRemainingStockFooter.textContent = (totalInputQty - totalOutputQty).toLocaleString();
        };

        const updateVendorFilterOptions = (records) => {
            const uniqueVendors = [...new Set(records.map(r => r.vendorName))].sort();
            vendorFilter.innerHTML = '<option value="all">All Vendors</option>';
            uniqueVendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor;
                option.textContent = vendor;
                vendorFilter.appendChild(option);
            });
            const currentFilter = vendorFilter.value;
            if (uniqueVendors.includes(currentFilter)) {
                vendorFilter.value = currentFilter;
            }
        };

        const filterRecords = () => {
            const selectedVendor = vendorFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            const start = startDateInput.value ? new Date(startDateInput.value).setHours(0,0,0,0) : null;
            const end = endDateInput.value ? new Date(endDateInput.value).setHours(23,59,59,999) : null;
            let filteredRawRecords = allRecords.filter(record => {
                const recordDate = new Date(record.date).setHours(0,0,0,0);
                const matchesDate = (!start || recordDate >= start) && (!end || recordDate <= end);
                const matchesVendor = (selectedVendor === 'all' || record.vendorName === selectedVendor);
                const matchesSearch = (
                    record.challanNo.toLowerCase().includes(searchTerm) ||
                    record.sku.toLowerCase().includes(searchTerm) ||
                    record.vendorName.toLowerCase().includes(searchTerm) ||
                    record.color?.toLowerCase().includes(searchTerm) ||
                    record.type.toLowerCase().includes(searchTerm) ||
                    record.date.includes(searchTerm) ||
                    record.remarks?.toLowerCase().includes(searchTerm)
                );
                return matchesDate && matchesVendor && matchesSearch;
            });
            calculateAggregatedStock(filteredRawRecords);
            renderAggregatedRecordsTable(aggregatedStock);
            renderTransactionTable(filteredRawRecords);
        };

        window.deleteRecord = async (recordId) => {
            const confirmDelete = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-800 p-8 rounded-lg shadow-lg text-center w-80">
                        <p class="text-lg font-semibold mb-4">Are you sure?</p>
                        <p class="text-gray-300 mb-6">This record will be permanently deleted and stock levels will be affected.</p>
                        <div class="flex justify-center gap-4">
                            <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                            <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('cancelDeleteBtn').addEventListener('click', () => { document.body.removeChild(modal); resolve(false); });
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => { document.body.removeChild(modal); resolve(true); });
            });
            if (confirmDelete) {
                try {
                    if (!db || !userId) { showMessage('Database not ready or user not logged in.', 'error'); return; }
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const appId = firebaseConfig.appId || 'default-app-id';
                    const recordRef = doc(db, `artifacts/${appId}/users/${userId}/material_records`, recordId);
                    await deleteDoc(recordRef);
                    showMessage('Record deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting record:', error);
                    showMessage('Error deleting record', 'error');
                }
            }
        };

        const exportToCSV = () => {
            const headers = ['Date', 'Challan No', 'SKU', 'Color', 'Quantity', 'Rate', 'Value', 'Vendor Name', 'Remarks', 'Type'];
            const csvContent = [
                headers.join(','),
                ...allRecords.map(record => [
                    record.date,
                    record.challanNo,
                    record.sku,
                    record.color || '',
                    record.qty,
                    record.rate,
                    (parseFloat(record.qty) * parseFloat(record.rate)).toFixed(2),
                    record.vendorName,
                    record.remarks || '',
                    record.type === 'Input' ? 'Output' : 'Issue'
                ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `material_transactions_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };

        const setupRealtimeListener = () => {
            if (!db || !userId) {
                console.log("Firestore or User ID not ready for listener setup. Retrying in 500ms.");
                setTimeout(setupRealtimeListener, 500);
                return;
            }
            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = firebaseConfig.appId || 'default-app-id';
            const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/material_records`);
            const q = query(recordsCollectionRef, orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                allRecords = [];
                snapshot.forEach((doc) => { allRecords.push({ id: doc.id, ...doc.data() }); });
                calculateAggregatedStock(allRecords);
                updateStatistics();
                updateVendorFilterOptions(allRecords);
                updateFormFieldsForEntryType();
                filterRecords();
            }, (error) => {
                console.error("Error fetching real-time updates:", error);
                showMessage('Error fetching records. Please refresh the page.', 'error');
            });
        };

        const createSelectElement = (id, labelText, options, onChangeHandler, isRequired = false) => {
            const div = document.createElement('div');
            const label = document.createElement('label');
            label.htmlFor = id;
            label.className = 'form-label';
            label.innerHTML = `<i class="fas fa-${id.includes('vendor') ? 'store' : (id.includes('sku') ? 'barcode' : 'receipt')} mr-2"></i>${labelText}`;
            div.appendChild(label);
            const select = document.createElement('select');
            select.id = id;
            select.className = 'form-input';
            if (isRequired) select.required = true;
            select.addEventListener('change', onChangeHandler);
            options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                select.appendChild(option);
            });
            div.appendChild(select);
            return div;
        };

        const updateFormFieldsForEntryType = () => {
            clearForm();
            skuInputContainer.innerHTML = '';
            vendorInputContainer.innerHTML = '';
            challanSelectContainer.style.display = 'none';
            challanSelectContainer.innerHTML = '';

            if (currentEntryType === 'Input') {
                const uniqueVendors = [...new Set(allRecords.map(r => r.vendorName))].filter(Boolean).sort();
                const vendorOptions = ['Select Vendor...', ...uniqueVendors, 'Add New Vendor...'];
                const vendorSelectDiv = createSelectElement('vendorSelect', 'Vendor Name', vendorOptions, () => {
                    if (vendorSelectDropdown.value === 'Add New Vendor...') {
                        vendorInputContainer.innerHTML = `<label for="vendorName" class="form-label"><i class="fas fa-store mr-2"></i>Vendor Name</label><input type="text" id="vendorName" class="form-input" placeholder="Enter new vendor name" required>`;
                        vendorInputText = document.getElementById('vendorName');
                        vendorSelectDropdown = null;
                    }
                }, true);
                vendorInputContainer.appendChild(vendorSelectDiv);
                vendorSelectDropdown = document.getElementById('vendorSelect');

                skuInputContainer.innerHTML = `<label for="sku" class="form-label"><i class="fas fa-barcode mr-2"></i>SKU</label><input type="text" id="sku" class="form-input" placeholder="e.g., BW6085BLUE_DRS-S" required>`;
                skuInputText = document.getElementById('sku');
            } else {
                const uniqueInputVendors = [...new Set(allRecords.filter(r => r.type === 'Input').map(r => r.vendorName))].filter(Boolean).sort();
                const vendorOptions = ['Select Vendor...', ...uniqueInputVendors];
                const vendorSelectDiv = createSelectElement('vendorSelect', 'Vendor Name', vendorOptions, handleVendorSelectChange, true);
                vendorInputContainer.appendChild(vendorSelectDiv);
                vendorSelectDropdown = document.getElementById('vendorSelect');

                const skuSelectDiv = createSelectElement('skuSelect', 'SKU', ['Select SKU...'], handleSkuSelectChange, true);
                skuInputContainer.appendChild(skuSelectDiv);
                skuSelectDropdown = document.getElementById('skuSelect');

                const challanSelectDiv = createSelectElement('challanSelect', 'Challan No', ['Select Challan...'], handleChallanSelectChange, true);
                challanSelectContainer.appendChild(challanSelectDiv);
                challanSelectDropdown = document.getElementById('challanSelect');
            }
            dateInput.value = new Date().toISOString().split('T')[0];
        };

        const handleVendorSelectChange = () => {
            const selectedVendor = vendorSelectDropdown.value;
            const skuOptions = ['Select SKU...'];
            if (selectedVendor !== 'Select Vendor...') {
                const uniqueSkusForVendor = [...new Set(allRecords.filter(r => r.type === 'Input' && r.vendorName === selectedVendor).map(r => r.sku))].sort();
                skuOptions.push(...uniqueSkusForVendor);
            }
            skuSelectDropdown.innerHTML = '';
            skuOptions.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                skuSelectDropdown.appendChild(option);
            });
            skuSelectDropdown.value = 'Select SKU...';
            challanSelectDropdown.innerHTML = '<option value="Select Challan...">Select Challan...</option>';
            challanSelectContainer.style.display = 'none';
            colorInput.value = '';
            qtyInput.value = '';
            rateInput.value = '';
            qtyInput.max = '';
            challanNoInput.value = '';
            remarksInput.value = '';
        };

        const handleSkuSelectChange = () => {
            const selectedSku = skuSelectDropdown.value;
            const selectedVendor = vendorSelectDropdown.value;
            const challanOptions = ['Select Challan...'];
            if (selectedSku !== 'Select SKU...' && selectedVendor) {
                const uniqueChallansForSku = [...new Set(allRecords.filter(r => r.type === 'Input' && r.vendorName === selectedVendor && r.sku === selectedSku).map(r => r.challanNo))].sort();
                challanOptions.push(...uniqueChallansForSku);
                challanSelectContainer.style.display = 'block';
            } else {
                challanSelectContainer.style.display = 'none';
            }
            challanSelectDropdown.innerHTML = '';
            challanOptions.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                challanSelectDropdown.appendChild(option);
            });
            challanSelectDropdown.value = 'Select Challan...';
            colorInput.value = '';
            qtyInput.value = '';
            rateInput.value = '';
            qtyInput.max = '';
            challanNoInput.value = '';
            remarksInput.value = '';
        };

        const handleChallanSelectChange = () => {
            const selectedSku = skuSelectDropdown.value;
            const selectedVendor = vendorSelectDropdown.value;
            const selectedChallan = challanSelectDropdown.value;
            if (selectedSku !== 'Select SKU...' && selectedVendor && selectedChallan !== 'Select Challan...') {
                const relevantInputRecord = allRecords.filter(r => r.type === 'Input' && r.sku === selectedSku && r.vendorName === selectedVendor && r.challanNo === selectedChallan).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                if (relevantInputRecord) {
                    colorInput.value = relevantInputRecord.color || '';
                    rateInput.value = parseFloat(relevantInputRecord.rate).toFixed(2);
                    challanNoInput.value = relevantInputRecord.challanNo;
                    remarksInput.value = relevantInputRecord.remarks || '';
                    let inputQtyForChallan = relevantInputRecord.qty;
                    let outputQtyFromThisChallan = allRecords.filter(r => (r.type === 'Output') && r.sku === selectedSku && r.color === relevantInputRecord.color && r.challanNo === selectedChallan).reduce((sum, r) => sum + r.qty, 0);
                    const availableQty = inputQtyForChallan - outputQtyFromThisChallan;
                    qtyInput.value = availableQty > 0 ? availableQty : 0;
                    qtyInput.max = availableQty;
                    qtyInput.min = 1;
                    showMessage(`Available stock from Challan ${selectedChallan} for ${selectedSku} (${relevantInputRecord.color}): ${availableQty}`, 'success');
                } else {
                    colorInput.value = '';
                    qtyInput.value = '';
                    rateInput.value = '';
                    qtyInput.max = '';
                    challanNoInput.value = '';
                    remarksInput.value = '';
                    showMessage('No matching input record found for this Challan.', 'error');
                }
            } else {
                colorInput.value = '';
                qtyInput.value = '';
                rateInput.value = '';
                qtyInput.max = '';
                challanNoInput.value = '';
                remarksInput.value = '';
            }
        };

        const printChallan = (recordToPrint) => {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert("Please allow pop-ups for this website to print the challan.");
                return;
            }
            const dateFormatted = new Date(recordToPrint.date).toLocaleDateString('en-GB');
            const challanContent = `
                <div class="print-challan" style="padding: 20px;">
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; }
                        table { width: 100%; border-collapse: collapse; }
                        .header, .footer, .details, .items { width: 100%; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 24px; text-align: center; }
                        .header p { margin: 2px 0; font-size: 10px; text-align: center; }
                        .details td { padding: 5px; font-size: 12px; }
                        .items th, .items td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; }
                        .items th { background-color: #f2f2f2; }
                        .items tfoot td { font-weight: bold; }
                        .signatures { width: 100%; margin-top: 50px; }
                        .signatures td { width: 50%; padding-top: 20px; text-align: center; font-size: 12px; }
                    </style>
                    <table class="header">
                        <tr>
                            <td colspan="2" style="text-align: center;">
                                <p style="font-size: 8px; margin: 0;">GST NO.: 07AAICC7276K1Z5</p>
                                <h1 style="font-size: 16px; margin: 5px 0;">Cheshtaa Apparels India Pvt. Ltd.</h1>
                                <p style="font-size: 10px; margin: 0;">Manufacture & Exporter of Fashion Garments</p>
                                <p style="font-size: 8px; margin: 0;">Plot no 78, Bijwasan Rd, near Sarovar Portico Hotel,</p>
                                <p style="font-size: 8px; margin: 0;">Kapas Hera Extension, Kapas Hera, New Delhi, Delhi 110037</p>
                            </td>
                        </tr>
                    </table>
                    <table class="details">
                        <tr>
                            <td style="width: 50%;"><b>No.</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${recordToPrint.challanNo}</td>
                            <td style="width: 50%; text-align: right;"><b>Dated:</b>&nbsp;${dateFormatted}</td>
                        </tr>
                        <tr>
                            <td colspan="2"><b>M/s.</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${recordToPrint.vendorName}</td>
                        </tr>
                        <tr>
                            <td colspan="2" style="height: 40px; border-bottom: 1px solid #000;"></td>
                        </tr>
                    </table>
                    <table class="items">
                        <thead>
                            <tr>
                                <th>S.No.</th>
                                <th>PARTICULARS</th>
                                <th>Qty.</th>
                                <th>Rate</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>${recordToPrint.sku} (${recordToPrint.color})</td>
                                <td>${recordToPrint.qty}</td>
                                <td>${recordToPrint.rate}</td>
                                <td>${recordToPrint.remarks || ''}</td>
                            </tr>
                            <tr>
                                <td colspan="2" style="text-align: right;">Total:</td>
                                <td>${recordToPrint.qty}</td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="signatures">
                        <tr>
                            <td>Receiver Signature</td>
                            <td style="text-align: right;">For Cheshtaa Apparels India Pvt. Ltd.</td>
                        </tr>
                        <tr>
                            <td style="border-top: 1px solid #000;"></td>
                            <td style="border-top: 1px solid #000; text-align: right;">Auth. Sign.</td>
                        </tr>
                    </table>
                </div>
            `;
            printWindow.document.write(challanContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        };

        window.printChallanFromRecord = (recordId) => {
            const recordToPrint = allRecords.find(record => record.id === recordId);
            if (recordToPrint) {
                printChallan(recordToPrint);
            } else {
                showMessage('Record not found for printing.', 'error');
            }
        };

        window.editRecord = (recordId) => {
            const recordToEdit = allRecords.find(record => record.id === recordId);
            if (recordToEdit) {
                editRecordIdInput.value = recordToEdit.id;
                editDateInput.value = recordToEdit.date;
                editChallanNoInput.value = recordToEdit.challanNo;
                editSkuInput.value = recordToEdit.sku;
                editColorInput.value = recordToEdit.color;
                editQtyInput.value = recordToEdit.qty;
                editRateInput.value = recordToEdit.rate;
                editVendorNameInput.value = recordToEdit.vendorName;
                editRemarksInput.value = recordToEdit.remarks;
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            } else {
                showMessage('Record not found for editing.', 'error');
            }
        };

        const closeEditModal = () => {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        };

        inputBtn.addEventListener('click', () => {
            currentEntryType = 'Input';
            formTitle.innerHTML = '<i class="fas fa-plus mr-2"></i>Record Output Material';
            inputBtn.classList.add('active');
            inputBtn.classList.remove('inactive');
            outputBtn.classList.remove('active');
            outputBtn.classList.add('inactive');
            updateFormFieldsForEntryType();
        });

        outputBtn.addEventListener('click', () => {
            currentEntryType = 'Output';
            formTitle.innerHTML = '<i class="fas fa-minus mr-2"></i>Record Issued Material';
            outputBtn.classList.add('active');
            outputBtn.classList.remove('inactive');
            inputBtn.classList.remove('active');
            inputBtn.classList.add('inactive');
            updateFormFieldsForEntryType();
        });

        materialForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                showMessage('Database is not initialized or user ID is missing. Please refresh and try again.', 'error');
                return;
            }
            let record = {};
            record.date = dateInput.value;
            record.challanNo = challanNoInput.value.trim();
            record.color = colorInput.value.trim();
            record.qty = parseInt(qtyInput.value);
            record.rate = parseFloat(rateInput.value);
            record.remarks = remarksInput.value.trim();
            record.type = currentEntryType;
            record.timestamp = new Date().toISOString();

            let finalVendorName = '';
            let finalSku = '';

            if (currentEntryType === 'Input') {
                const vendorElement = document.getElementById('vendorSelect') || document.getElementById('vendorName');
                const skuInput = document.getElementById('sku');
                if (!skuInput || !vendorElement) { showMessage('SKU or Vendor Name input field not found.', 'error'); return; }
                if(vendorSelectDropdown && vendorSelectDropdown.value === 'Add New Vendor...') {
                    finalVendorName = document.getElementById('vendorName').value.trim();
                } else if(vendorSelectDropdown) {
                    finalVendorName = vendorSelectDropdown.value;
                } else {
                    finalVendorName = vendorElement.value.trim();
                }
                finalSku = skuInput.value.trim();
            } else { // 'Output'
                const skuSelect = document.getElementById('skuSelect');
                const vendorSelect = document.getElementById('vendorSelect');
                const challanSelect = document.getElementById('challanSelect');
                if (!skuSelect || !vendorSelect || !challanSelect) { showMessage('Required form fields not found.', 'error'); return; }
                finalSku = skuSelect.value;
                finalVendorName = vendorSelect.value;
                record.challanNo = challanSelect.value;
            }
            
            record.vendorName = finalVendorName;
            record.sku = finalSku;

            if (!record.date || !record.challanNo || !record.sku || isNaN(record.qty) || isNaN(record.rate) || !record.vendorName ||
                record.vendorName === 'Select Vendor...' || (currentEntryType === 'Output' && record.challanNo === 'Select Challan...') || record.sku === 'Select SKU...') {
                showMessage('Please fill in all required fields and make valid selections.', 'error');
                return;
            }
            if (record.qty <= 0 || record.rate < 0) {
                showMessage('Quantity must be positive and Rate cannot be negative.', 'error');
                return;
            }
            if (currentEntryType === 'Output') {
                const selectedChallan = document.getElementById('challanSelect').value;
                const relevantInputRecord = allRecords.find(r => r.type === 'Input' && r.sku === record.sku && r.color === record.color && r.vendorName === record.vendorName && r.challanNo === selectedChallan);
                if (!relevantInputRecord) {
                    showMessage('Could not find a matching input record for the selected Challan, SKU, Vendor, and Color.', 'error');
                    return;
                }
                let inputQtyForChallan = relevantInputRecord.qty;
                let outputQtyFromThisChallan = allRecords.filter(r => (r.type === 'Output') && r.sku === record.sku && r.color === record.color && r.challanNo === selectedChallan).reduce((sum, r) => sum + r.qty, 0);
                const availableQty = inputQtyForChallan - outputQtyFromThisChallan;
                if (record.qty > availableQty) {
                    showMessage(`Output quantity (${record.qty}) exceeds available stock (${availableQty}) from Challan ${selectedChallan} for ${record.sku} (${record.color}).`, 'error');
                    return;
                }
            }
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const appId = firebaseConfig.appId || 'default-app-id';
                const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/material_records`);
                await addDoc(recordsCollectionRef, record);
                showMessage('Record added successfully!', 'success');
                clearForm();
            } catch (error) {
                console.error('Error adding record:', error);
                showMessage('Error adding record. Please try again.', 'error');
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const recordId = editRecordIdInput.value;
            if (!recordId) { showMessage('Record ID missing.', 'error', 'editMessage'); return; }
            const updatedRecord = {
                date: editDateInput.value,
                challanNo: editChallanNoInput.value.trim(),
                sku: editSkuInput.value.trim(),
                color: editColorInput.value.trim(),
                qty: parseInt(editQtyInput.value),
                rate: parseFloat(editRateInput.value),
                vendorName: editVendorNameInput.value.trim(),
                remarks: editRemarksInput.value.trim(),
            };
            if (updatedRecord.qty <= 0 || updatedRecord.rate < 0) {
                showMessage('Quantity must be positive and Rate cannot be negative.', 'error', 'editMessage');
                return;
            }
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const appId = firebaseConfig.appId || 'default-app-id';
                const recordRef = doc(db, `artifacts/${appId}/users/${userId}/material_records`, recordId);
                await updateDoc(recordRef, updatedRecord);
                showMessage('Record updated successfully!', 'success', 'editMessage');
                closeEditModal();
            } catch (error) {
                console.error('Error updating record:', error);
                showMessage('Error updating record. Please try again.', 'error', 'editMessage');
            }
        });

        vendorFilter.addEventListener('change', filterRecords);
        searchInput.addEventListener('input', filterRecords);
        startDateInput.addEventListener('change', filterRecords);
        endDateInput.addEventListener('change', filterRecords);
        exportBtn.addEventListener('click', exportToCSV);
        logoutBtn.addEventListener('click', logout);
        printChallanBtn.addEventListener('click', () => {
            const record = {
                date: dateInput.value,
                challanNo: challanNoInput.value,
                sku: currentEntryType === 'Input' ? skuInputText?.value : skuSelectDropdown?.value,
                color: colorInput.value,
                qty: parseInt(qtyInput.value),
                rate: parseFloat(rateInput.value),
                vendorName: currentEntryType === 'Input' ? (vendorSelectDropdown?.value === 'Add New Vendor...' ? vendorInputText?.value : vendorSelectDropdown?.value) : (vendorSelectDropdown?.value || vendorInputText?.value),
                remarks: remarksInput.value
            };
            if (!record.date || !record.challanNo || !record.sku || isNaN(record.qty) || isNaN(record.rate) || !record.vendorName) {
                showMessage('Please fill in all required fields before printing a challan.', 'error');
                return;
            }
            printChallan(record);
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            const success = handleLogin(username, password);
            if (!success) {
                showMessage('Invalid username or password.', 'error', 'loginMessage');
            }
        });

        demoLoginBtn.addEventListener('click', () => {
            const username = 'demo';
            const password = 'demo';
            const success = handleLogin(username, password);
            if (!success) {
                showMessage('Demo account login failed. Please check the hardcoded credentials.', 'error', 'loginMessage');
            }
        });

        closeEditModalBtn.addEventListener('click', closeEditModal);
        cancelEditBtn.addEventListener('click', closeEditModal);

        document.addEventListener('DOMContentLoaded', initializeFirebase);

        const addDemoData = async () => {
            if (currentUser && db && userId) {
                const firebaseConfig = JSON.parse(__firebase_config);
                const appId = firebaseConfig.appId || 'default-app-id';
                const recordsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/material_records`);
                try {
                    const existingDocs = await getDocs(query(recordsCollectionRef));
                    if (existingDocs.empty) {
                        const sampleRecords = [
                            { date: '2025-07-01', challanNo: 'IN-001', sku: 'BW6085BLUE_DRS-S', color: 'Blue', qty: 100, rate: 1000.00, vendorName: 'Myntra - SJIT', type: 'Input', timestamp: new Date('2025-07-01T10:00:00Z').toISOString(), remarks: 'Initial stock input' },
                            { date: '2025-07-05', challanNo: 'IN-002', sku: 'BW6085BLUE_DRS-L', color: 'Blue', qty: 50, rate: 1200.00, vendorName: 'Myntra - SJIT', type: 'Input', timestamp: new Date('2025-07-05T11:00:00Z').toISOString(), remarks: 'New variant added' },
                            { date: '2025-07-10', challanNo: 'IN-003', sku: 'BW8034GREY_COD-M', color: 'Grey', qty: 75, rate: 800.00, vendorName: 'Amazon - Fashion', type: 'Input', timestamp: new Date('2025-07-10T12:00:00Z').toISOString(), remarks: 'Regular supply' },
                            { date: '2025-07-15', challanNo: 'OUT-001', sku: 'BW6085BLUE_DRS-S', color: 'Blue', qty: 20, rate: 1000.00, vendorName: 'Myntra - SJIT', type: 'Output', timestamp: new Date('2025-07-15T13:00:00Z').toISOString(), remarks: 'Shipped to warehouse' },
                            { date: '2025-07-20', challanNo: 'IN-004', sku: 'BW6085BLUE_DRS-S', color: 'Blue', qty: 30, rate: 1050.00, vendorName: 'Myntra - SJIT', type: 'Input', timestamp: new Date('2025-07-20T14:00:00Z').toISOString(), remarks: 'Special restock' },
                            { date: '2025-07-25', challanNo: 'OUT-002', sku: 'BW8034GREY_COD-M', color: 'Grey', qty: 10, rate: 800.00, vendorName: 'Amazon - Fashion', type: 'Output', timestamp: new Date('2025-07-25T15:00:00Z').toISOString(), remarks: 'Sent for client inspection' },
                            { date: '2025-07-25', challanNo: 'OUT-003', sku: 'BW6085BLUE_DRS-S', color: 'Blue', qty: 10, rate: 1000.00, vendorName: 'Myntra - SJIT', type: 'Output', timestamp: new Date('2025-07-25T16:00:00Z').toISOString(), remarks: 'Urgent order' },
                            { date: '2025-07-28', challanNo: 'IN-005', sku: 'BW6083BLUE_DRS-L', color: 'Light Blue', qty: 40, rate: 950.00, vendorName: 'Flipkart - Retail', type: 'Input', timestamp: new Date('2025-07-28T09:00:00Z').toISOString(), remarks: 'New supplier batch' }
                        ];
                        for (const record of sampleRecords) { await addDoc(recordsCollectionRef, record); }
                        console.log("Demo data added.");
                    }
                } catch (error) {
                    console.error("Error checking or adding demo data:", error);
                }
            }
        };
    </script>
</body>
</html>
